<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"><meta property="og:title" content="BigQuery: SQL" />
<meta property="og:description" content="BigQuery: SQL 基本文法 標準 SQL のクエリ構文 標準SQLの演算子 標準SQLの関数と演算子 レギュラーSQLをデフォルトにする クエリの前に #standardSQL の記述を追加する。逆" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://teuder.github.io/notebook/gcp/bigquery_sql/" />
<meta property="article:published_time" content="2019-09-04T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-09-10T20:10:59+09:00" />
<title>BigQuery: SQL | notebook</title>
<link rel="icon" href="/notebook/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/notebook/book.min.07c38dce7b6800da2a75a565d4d975e38f837294e24d00b5aae363037012d64b.css" integrity="sha256-B8ONzntoANoqdaVl1Nl144&#43;DcpTiTQC1quNjA3AS1ks=">


<script defer src="/notebook/search.min.c6e9900d419b30096c6716696c3dd2b45e229bd951b9f7d34ceaeb8cc36e233f.js" integrity="sha256-xumQDUGbMAlsZxZpbD3StF4im9lRuffTTOrrjMNuIz8="></script>

<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="flex container">

    <aside class="book-menu fixed">
      <nav>
<h2 class="book-brand">
  <a href="https://teuder.github.io/notebook/"><span>notebook</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" placeholder="Search" id="book-search-input" maxlength="64" />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>





    

  






  <ul>
  
    

  <li >
    
      

  <a href="/notebook/docs/" >
      About
  </a>


    

    




  
  <ul>
    
  </ul>
  



  </li>


  
    

  <li >
    
      

  <a href="/notebook/python/" >
      Python
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/notebook/python/bigquery/" >
      BigQuery
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/python/environment/" >
      environment
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/python/jupyter/" >
      jupyter
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/python/pandas/" >
      Pandas
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/python/vscode/" >
      Python in VScode
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/python/anaconda/" >
      anaconda
  </a>

</li>
      
    
  </ul>
  



  </li>


  
    

  <li >
    
      

  <a href="/notebook/r/" >
      R
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/notebook/r/leaflet/" >
      leaflet
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/rhdf5/" >
      rhdf5
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/ggplot2/" >
      ggplot2
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/raster/" >
      raster
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/sf/" >
      sf
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/bigrquery/" >
      bigrquery
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/dplyr/" >
      dplyr
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/future/" >
      future
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/gganimate/" >
      gganimate
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/lubridate/" >
      lubridate
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/purrr/" >
      purrr
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/package_development/" >
      R Package Development
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/r_python/" >
      R_Python
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/reticulate/" >
      reticulate
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/rmarkdown/" >
      Rmarkdown
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/rpart/" >
      rpart
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/rstudio/" >
      RStudio
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/stars/" >
      stars
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/stringr/" >
      stringr
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/tidymodels/" >
      tidymodels
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/wk/" >
      wk
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/dbi/" >
      DBI
  </a>

</li>
      
    
  </ul>
  



  </li>


  
    

  <li >
    
      

  <a href="/notebook/datascience/" >
      Data Science
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/notebook/datascience/bayesian_statistics/" >
      Bayesian Staistics
  </a>

</li>
      
    
  </ul>
  



  </li>


  
    

  <li >
    
      

  <a href="/notebook/gis/" >
      GIS &amp; Remote Sensing
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/notebook/gis/bigquerygis/" >
      BigQuery GIS
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/gis/sar/" >
      SAR
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/gis/terminology/" >
      用語
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/gis/viirs/" >
      VIIRS
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/gis/r_package/" >
      GIS関連Rパッケージ
  </a>

</li>
      
    
  </ul>
  



  </li>


  
    

  <li >
    
      

  <a href="/notebook/mac/" >
      Mac
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/notebook/mac/homebrew/" >
      homebrew
  </a>

</li>
      
    
  </ul>
  



  </li>


  
    

  <li >
    
      

  <a href="/notebook/maritime/" >
      Maritime
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/notebook/maritime/glossary/" >
      glossary
  </a>

</li>
      
    
  </ul>
  



  </li>


  
    

  <li >
    
      

  <a href="/notebook/gcp/" >
      Google Cloud Platform
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/notebook/gcp/bigquery_gis/" >
      BigQuery GIS
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/gcp/bigquery_bq/" >
      BigQuery: bqコマンド
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/gcp/bigquery/" >
      BigQuery: general
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/gcp/bigquery_sql/"  class="active">
      BigQuery: SQL
  </a>

</li>
      
    
  </ul>
  



  </li>


  
    

  <li >
    
      

  <a href="/notebook/miscellaneous/" >
      miscellaneous
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/notebook/miscellaneous/english/" >
      english
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/miscellaneous/jinjia2/" >
      jinja
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/miscellaneous/jupyter/" >
      jupyter
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/miscellaneous/pc/" >
      PC
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/miscellaneous/tmux/" >
      tmux
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/miscellaneous/vscode/" >
      vscode
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/miscellaneous/windows/" >
      Windows
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/miscellaneous/hugo/" >
      Hugo
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/miscellaneous/git/" >
      git
  </a>

</li>
      
    
  </ul>
  



  </li>


  
  </ul>











</nav>


<script>
(function() {
  var menu = document.querySelector("aside.book-menu nav");
  addEventListener("beforeunload", function(event) {
    localStorage.setItem("menu.scrollTop", menu.scrollTop);
  });
  menu.scrollTop = localStorage.getItem("menu.scrollTop");
})();
</script>

    </aside>

    <div class="book-page">
      <header class="flex align-center justify-between book-header">
  <label for="menu-control">
    <img src="/notebook/svg/menu.svg" alt="Menu" />
  </label>
  <strong>BigQuery: SQL</strong>
</header>

      
<article class="markdown"><h1 id="bigquery-sql">BigQuery: SQL</h1>
<h2 id="基本文法">基本文法</h2>
<ul>
<li><a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/query-syntax">標準 SQL のクエリ構文</a></li>
<li><a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/operators?hl=ja">標準SQLの演算子</a></li>
<li><a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators?hl=ja">標準SQLの関数と演算子</a></li>
</ul>
<h2 id="レギュラーsqlをデフォルトにする">レギュラーSQLをデフォルトにする</h2>
<p>クエリの前に <code>#standardSQL</code> の記述を追加する。逆にレガシーにしたい場合は <code>#legacySQL</code> を記述する。</p>
<pre><code class="language-{sql}" data-lang="{sql}">#standardSQL
SELECT
  weight_pounds, state, year, gestation_weeks
FROM
  `bigquery-public-data.samples.natality`
ORDER BY weight_pounds DESC
LIMIT 10;
</code></pre><p><code>.bigqueryrc</code> に以下を記述</p>
<pre><code>[query]
--use_legacy_sql=false

[mk]
--use_legacy_sql=false
</code></pre><h3 id="実数を丸める関数">実数を丸める関数</h3>
<ul>
<li><code>ROUND()</code></li>
<li><code>CEILING()</code></li>
<li><code>FLOOR()</code></li>
<li><code>TRUNC()</code></li>
</ul>
<p><a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators?hl=ja#floor">丸め関数の挙動</a></p>
<p><img src="ceil_floor_trunc_round.jpeg" alt="Pythonの丸め関数の挙動、多分BigQueryと同じ" title="Pythonの丸め関数の挙動"></p>
<h3 id="行の抽出">行の抽出</h3>
<h4 id="where-column-in-sub_query-">WHERE column IN( sub_query )</h4>
<p>列の値が、サブクエリの出力結果と同じ値をもつ行だけを抽出する</p>
<pre><code>SELECT
  *
FROM
  tableA
WHERE
  item IN (
    SELECT
      product
    FROM
      tableB
  )
</code></pre><h4 id="where-exists-sub_query-">WHERE EXISTS( sub_query )</h4>
<p>サブクエリのなかのwhere句で抽出したいレコードの条件を指定する。</p>
<pre><code>SELECT
  *
FROM
  tableA
WHERE
  EXISTS (
    SELECT
      product
    FROM
      tableB
    WHERE
      tableA.item = tableB.product
      AND tableA.price = tableB.price
  )
</code></pre><h3 id="カラム名を取得する">カラム名を取得する</h3>
<pre><code>SELECT
  column_name
FROM
  dataset_name.INFORMATION_SCHEMA.COLUMNS
WHERE
  table_name = 'table_name'
</code></pre><p>カラム名を取得して、INSERT SELECT 用の文字列を生成する</p>
<pre><code>WITH ColumnNames AS (
  SELECT column_name  FROM scratch_masaki.INFORMATION_SCHEMA.COLUMNS
  WHERE table_name = 'viirs_ais_matching_20200101_masaki'
)
SELECT CONCAT(
  'INSERT dataset.tablename (',
  ARRAY_TO_STRING(ARRAY(SELECT column_name FROM ColumnNames), ', '),    
  ')');
</code></pre><h2 id="文字列">文字列</h2>
<h3 id="部分文字列-substr">部分文字列: SUBSTR</h3>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#111">SUBSTR</span><span style="color:#111">(</span><span style="color:#960050;background-color:#1e0010">カラム</span><span style="color:#111">,</span> <span style="color:#960050;background-color:#1e0010">開始位置</span> <span style="color:#111">[,</span><span style="color:#960050;background-color:#1e0010">長さ</span><span style="color:#111">])</span>
</code></pre></div><h2 id="日付">日付</h2>
<h3 id="日付要素を取り出す">日付要素を取り出す</h3>
<pre><code>EXTRACT(要素 FROM DATEカラム)
</code></pre><p>要素としては以下を指定できる</p>
<ul>
<li><code>DAY</code></li>
<li><code>MONTH</code></li>
<li><code>QUARTER</code>: 範囲 [1,4] 内の値</li>
<li><code>YEAR</code></li>
<li><code>DAYOFWEEK</code> 日曜が1, 土曜が7</li>
<li><code>DAYOFYEAR</code></li>
<li><code>WEEK</code>: 範囲 [0, 53] 内の日付の週番号を返します。週は日曜日から始まり、年の最初の日曜日より前の日付は 0 週目です</li>
<li><code>WEEK(&lt;WEEKDAY&gt;)</code>: 範囲 [0, 53] 内の日付の週番号を返します。週は WEEKDAY から始まります。最初の WEEKDAY より前の日付は、第 0 週になります。 <code>WEEKDAY</code> の有効な値は、SUNDAY、MONDAY、TUESDAY、WEDNESDAY、THURSDAY、FRIDAY、SATURDAY です。</li>
<li><code>ISOYEAR</code></li>
<li><code>ISOWEEK</code></li>
</ul>
<h1 id="ランダムサンプル">ランダムサンプル</h1>
<h2 id="tablesample-句">TABLESAMPLE 句</h2>
<p>10%のレコードを抽出する。</p>
<pre><code>SELECT * FROM dataset.my_table TABLESAMPLE SYSTEM (10 PERCENT)
</code></pre><p>注意：ただし、<code>TABLESAMPLE</code> を使った場合は、データの抽出は行ごとに行われるのではない。</p>
<p>大きいテーブルは「データブロック」と呼ばれる単位に分割されてで保存されているのだが、例えば、 <code>TABLESAMPLE SYSTEM (20 PERCENT)</code> とすると全体の 20% のデータブロックがランダムに抽出される。小さいテーブル（1GB未満）では１つのデータブロックに全てのデータが格納されるため、 <code>TABLESAMPLE</code> を使うと全てのデータが抽出される。</p>
<p>そこで、行ごとに厳密にランダムに抽出したいときは、次の　<code>WHERE rand()</code> を使用する。ただし、<code>WHERE rand()</code> を使用するとテーブル全体をスキャンするのでコストが大きくなることに注意する。<code>TABLESAMPLE</code> を使うとテーブル全体をスキャンしないのでクエリのコストは小さくなる。</p>
<h2 id="where-rand">WHERE rand()</h2>
<p>10%のレコードを抽出する。</p>
<pre><code>SELECT * FROM dataset.my_table WHERE rand() &lt; 0.1
</code></pre><p>ただし、 <code>WHERE rand()</code> を使用するとテーブル全体をスキャンするのでコストが大きくなることに注意する。<code>TABLESAMPLE</code> を使うとテーブル全体をスキャンしないのでクエリのコストは小さくなる。</p>
<h1 id="sharded-table">Sharded Table</h1>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">SELECT</span> <span style="color:#111">ssvid</span>
<span style="color:#00a8c8">FROM</span>

<span style="color:#f92672">`</span><span style="color:#111">world</span><span style="color:#f92672">-</span><span style="color:#111">fishing</span><span style="color:#f92672">-</span><span style="color:#ae81ff">827</span><span style="color:#111">.</span><span style="color:#111">pipe_production_v20201001</span><span style="color:#111">.</span><span style="color:#111">messages_scored_</span><span style="color:#f92672">*`</span>

<span style="color:#00a8c8">WHERE</span> 
<span style="color:#111">_TABLE_SUFFIX</span>
<span style="color:#00a8c8">BETWEEN</span> <span style="color:#d88200">&#39;20200101&#39;</span> <span style="color:#00a8c8">AND</span> <span style="color:#d88200">&#39;20201231&#39;</span>
</code></pre></div><h1 id="array">ARRAY</h1>
<h2 id="arrayの型">ARRAYの型</h2>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">
<span style="color:#00a8c8">SELECT</span>
  <span style="color:#111">ARRAY</span><span style="color:#f92672">&lt;</span><span style="color:#111">INT64</span><span style="color:#f92672">&gt;</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span><span style="color:#ae81ff">2</span><span style="color:#111">,</span><span style="color:#ae81ff">3</span><span style="color:#111">],</span>
  <span style="color:#111">ARRAY</span><span style="color:#f92672">&lt;</span><span style="color:#111">STRUCT</span><span style="color:#f92672">&lt;</span><span style="color:#111">INT64</span><span style="color:#111">,</span> <span style="color:#111">INT64</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#111">,</span>
  <span style="color:#f92672">#</span> <span style="color:#111">ARRAY</span><span style="color:#f92672">&lt;</span><span style="color:#111">ARRAY</span><span style="color:#f92672">&lt;</span><span style="color:#111">INT64</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#111">[[</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span><span style="color:#ae81ff">2</span><span style="color:#111">],[</span><span style="color:#ae81ff">3</span><span style="color:#111">,</span><span style="color:#ae81ff">4</span><span style="color:#111">,],[</span><span style="color:#ae81ff">5</span><span style="color:#111">,</span><span style="color:#ae81ff">6</span><span style="color:#111">]],</span> <span style="color:#f92672">#</span> <span style="color:#111">ARRAYを要素に持つARRAYは作成できない</span>
  <span style="color:#111">ARRAY</span><span style="color:#f92672">&lt;</span><span style="color:#111">STRUCT</span><span style="color:#f92672">&lt;</span><span style="color:#111">ARRAY</span><span style="color:#f92672">&lt;</span><span style="color:#111">INT64</span><span style="color:#f92672">&gt;&gt;&gt;</span><span style="color:#111">,</span>　             <span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">その代わりに</span> <span style="color:#111">ARRAYをSTRUCTで包めばそれを</span><span style="color:#960050;background-color:#1e0010">、</span><span style="color:#111">ARRAYとして格納できる</span>

</code></pre></div><p><a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/arrays">https://cloud.google.com/bigquery/docs/reference/standard-sql/arrays</a></p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">WITH</span>
<span style="color:#111">ownner_pet</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">(</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;tony&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">[</span><span style="color:#d88200">&#39;dog&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;cat&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span> <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;tim&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">[</span><span style="color:#d88200">&#39;cat&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;bird&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span> <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;nancy&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">[</span><span style="color:#d88200">&#39;dog&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;fish&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;lizard&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span> <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span>
<span style="color:#111">)</span>

</code></pre></div><p>pet は arrayとする。</p>
<p><code>ownner_pet</code> table</p>
<table>
<thead>
<tr>
<th>owner</th>
<th>pet</th>
</tr>
</thead>
<tbody>
<tr>
<td>tony</td>
<td>dog</td>
</tr>
<tr>
<td></td>
<td>cat</td>
</tr>
<tr>
<td>tim</td>
<td>cat</td>
</tr>
<tr>
<td></td>
<td>bird</td>
</tr>
<tr>
<td>nancy</td>
<td>dog</td>
</tr>
<tr>
<td></td>
<td>fish</td>
</tr>
<tr>
<td></td>
<td>lizard</td>
</tr>
</tbody>
</table>
<h2 id="array-を展開する-left-join-unnest-array">ARRAY を展開する LEFT JOIN UNNEST (array)</h2>
<p><code>LEFT JOIN UNNEST (array)</code> を使用する</p>
<p>下の例では <code>ais_identity.n_imo</code> が <code>array</code></p>
<p>これをすると、 <code>ais_identity.n_imo is null</code> の行は除外される</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">select</span>
  <span style="color:#111">ssvid</span><span style="color:#111">,</span>
  <span style="color:#111">best</span><span style="color:#111">.</span><span style="color:#111">best_flag</span><span style="color:#111">,</span>
  <span style="color:#111">ais_identity</span><span style="color:#111">.</span><span style="color:#111">flag_mmsi</span><span style="color:#111">,</span>
  <span style="color:#111">best</span><span style="color:#111">.</span><span style="color:#111">best_vessel_class</span><span style="color:#111">,</span>
  <span style="color:#111">ais_identity</span><span style="color:#111">.</span><span style="color:#111">n_shipname</span><span style="color:#111">,</span>
  <span style="color:#111">ais_identity</span><span style="color:#111">.</span><span style="color:#111">n_callsign</span><span style="color:#111">,</span>
  <span style="color:#111">n_imo</span><span style="color:#111">.</span><span style="color:#111">value</span> <span style="color:#00a8c8">as</span> <span style="color:#111">n_imo_value</span><span style="color:#111">,</span>
  <span style="color:#111">n_imo</span><span style="color:#111">.</span><span style="color:#00a8c8">count</span> <span style="color:#00a8c8">as</span> <span style="color:#111">n_imo_count</span><span style="color:#111">,</span>
  <span style="color:#111">n_imo</span><span style="color:#111">.</span><span style="color:#00a8c8">type</span> <span style="color:#00a8c8">as</span> <span style="color:#111">n_imo_type</span>
<span style="color:#00a8c8">from</span>
<span style="color:#f92672">`</span><span style="color:#111">world</span><span style="color:#f92672">-</span><span style="color:#111">fishing</span><span style="color:#f92672">-</span><span style="color:#ae81ff">827</span><span style="color:#111">.</span><span style="color:#111">gfw_research</span><span style="color:#111">.</span><span style="color:#111">vi_ssvid_v20200801</span><span style="color:#f92672">`</span>
<span style="color:#00a8c8">LEFT</span> <span style="color:#00a8c8">JOIN</span> <span style="color:#00a8c8">UNNEST</span><span style="color:#111">(</span><span style="color:#111">ais_identity</span><span style="color:#111">.</span><span style="color:#111">n_imo</span> <span style="color:#111">)</span> <span style="color:#00a8c8">as</span> <span style="color:#111">n_imo</span>
</code></pre></div><h2 id="where-in-unnest-array">WHERE IN UNNEST (array)</h2>
<p>Array の要素として特定の値が含まれるレコードを抽出する</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">SELECT</span>
  <span style="color:#f92672">*</span>
<span style="color:#00a8c8">FROM</span>
  <span style="color:#111">ownner_pet</span>
<span style="color:#00a8c8">WHERE</span> <span style="color:#00a8c8">IN</span> <span style="color:#00a8c8">UNNEST</span> <span style="color:#111">(</span><span style="color:#111">pet</span><span style="color:#111">)</span>
</code></pre></div><h2 id="where-exists--select--from-unnest-array-as-a-where-a--x">WHERE EXISTS ( SELECT * FROM UNNEST (array) as A WHERE A = &lsquo;X&rsquo;)</h2>
<p>Array が特定の条件を満たすレコードを抽出する <code>IN UNNEST</code> でよりも複雑な条件を指定することができる。</p>
<p>この例は　<code>IN UNNEST</code>　と同じ結果を返すけど、ARRAYの要素が STRUCT 等の場合や、もっと複雑な条件を指定したい場合は <code>WHERE EXIST</code> を使う</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">SELECT</span>
  <span style="color:#f92672">*</span>
<span style="color:#00a8c8">FROM</span>
  <span style="color:#111">ownner_pet</span>
<span style="color:#00a8c8">WHERE</span> <span style="color:#00a8c8">EXISTS</span> <span style="color:#111">(</span>
  <span style="color:#00a8c8">SELECT</span> <span style="color:#f92672">*</span>
  <span style="color:#00a8c8">FROM</span> <span style="color:#00a8c8">UNNEST</span> <span style="color:#111">(</span><span style="color:#111">pat</span><span style="color:#111">)</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">p</span>
  <span style="color:#00a8c8">WHERE</span> <span style="color:#111">p</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#39;bear&#39;</span>
<span style="color:#111">)</span>
</code></pre></div><h2 id="array-から一部の要素を取り出す">ARRAY から一部の要素を取り出す</h2>
<p>結果は元のテーブルの形式を保持したまま、一部の ARRAY 要素を取り出す</p>
<pre><code>WITH
ownner_pet AS (
SELECT 'tony' as owner, ['dog', 'cat'] as pet UNION ALL
SELECT 'tim' as owner, ['cat', 'bird'] as pet UNION ALL
SELECT 'nancy' as owner, ['dog', 'fish', 'lizard'] as pet 
)

SELECT
  owner,
  ARRAY (SELECT p FROM UNNEST (pet) as p WHERE p LIKE 'c%' ) as pet
FROM
  ownner_pet

</code></pre><h2 id="udf-を使った-array-処理">UDF を使った ARRAY 処理</h2>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">FUNCTION</span> <span style="color:#111">SORT_ARRAY</span><span style="color:#111">(</span><span style="color:#111">arr</span> <span style="color:#00a8c8">ANY</span> <span style="color:#00a8c8">TYPE</span><span style="color:#111">,</span> <span style="color:#111">ascending</span> <span style="color:#111">BOOL</span><span style="color:#111">)</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">(</span>
<span style="color:#00a8c8">IF</span> <span style="color:#111">(</span><span style="color:#111">ascending</span><span style="color:#111">,</span>
    <span style="color:#111">ARRAY</span> <span style="color:#111">(</span><span style="color:#00a8c8">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">FROM</span> <span style="color:#00a8c8">UNNEST</span> <span style="color:#111">(</span><span style="color:#111">arr</span><span style="color:#111">)</span> <span style="color:#111">a</span> <span style="color:#00a8c8">ORDER</span> <span style="color:#00a8c8">BY</span> <span style="color:#111">a</span><span style="color:#111">),</span>
    <span style="color:#111">ARRAY</span> <span style="color:#111">(</span><span style="color:#00a8c8">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">FROM</span> <span style="color:#00a8c8">UNNEST</span> <span style="color:#111">(</span><span style="color:#111">arr</span><span style="color:#111">)</span> <span style="color:#111">a</span> <span style="color:#00a8c8">ORDER</span> <span style="color:#00a8c8">BY</span> <span style="color:#111">a</span> <span style="color:#00a8c8">DESC</span><span style="color:#111">)</span> <span style="color:#111">)</span>
<span style="color:#111">);</span>


<span style="color:#00a8c8">WITH</span>
<span style="color:#111">ownner_pet</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">(</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;tony&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">[</span><span style="color:#d88200">&#39;dog&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;cat&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span> <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;tim&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">[</span><span style="color:#d88200">&#39;cat&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;bird&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span> <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;nancy&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">[</span><span style="color:#d88200">&#39;dog&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;fish&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;lizard&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span> 
<span style="color:#111">)</span>

<span style="color:#00a8c8">SELECT</span>
  <span style="color:#00a8c8">owner</span><span style="color:#111">,</span>
  <span style="color:#111">SORT_ARRAY</span><span style="color:#111">(</span><span style="color:#111">pet</span><span style="color:#111">,</span> <span style="color:#00a8c8">TRUE</span><span style="color:#111">)</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span>
<span style="color:#00a8c8">FROM</span>
  <span style="color:#111">ownner_pet</span>

</code></pre></div><p>　</p>
<h2 id="番号を使った-array-要素へのアクセス">番号を使った ARRAY 要素へのアクセス</h2>
<pre><code>WITH sequences AS
  (SELECT [0, 1, 1, 2, 3, 5] AS some_numbers
   UNION ALL SELECT [2, 4, 8, 16, 32] AS some_numbers
   UNION ALL SELECT [5, 10] AS some_numbers)
SELECT some_numbers,
       some_numbers[OFFSET(1)] AS offset_1,
       some_numbers[ORDINAL(1)] AS ordinal_1
FROM sequences;
</code></pre><h2 id="arrayの要素の結合">ARRAYの要素の結合</h2>
<p>ARRAY_CONCAT() のような関数を使用して複数の配列を結合し、ARRAY_TO_STRING() を使用して配列を文字列に変換できます。</p>
<h1 id="user-defined-functions">User Defined Functions</h1>
<pre><code># 定数をUDFとして保存する
CREATE TEMP FUNCTION START_DATE() AS (TIMESTAMP('2012-04-01'));

# 使い捨て関数
CREATE TEMP FUNCTION SORT_ARRAY(arr ANY TYPE, ascending BOOL) AS (
IF (ascending,
    ARRAY (SELECT * FROM UNNEST (arr) a ORDER BY a),
    ARRAY (SELECT * FROM UNNEST (arr) a ORDER BY a DESC) )
);


# テーブルを作成するときと同じようにUDFを保存することもできる
CREATE OR REPLACE FUNCTION `your_project.your_dataset.SORT_ARRAY`(arr ANY TYPE, ascending BOOL) AS (
IF (ascending,
    ARRAY (SELECT * FROM UNNEST (arr) a ORDER BY a),
    ARRAY (SELECT * FROM UNNEST (arr) a ORDER BY a DESC) )
);
</code></pre><h1 id="struct">STRUCT</h1>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#f92672">#</span> <span style="color:#111">STRUCT</span> <span style="color:#960050;background-color:#1e0010">を要素に持つカラム</span>
<span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">これだと</span><span style="color:#111">structとしてまとめる意義があまりないかも</span>
<span style="color:#00a8c8">WITH</span>
<span style="color:#111">ownner_pet</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">(</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;tony&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">STRUCT</span><span style="color:#111">(</span><span style="color:#d88200">&#39;dog&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#111">species</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">count</span><span style="color:#111">)</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span> <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;tim&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;cat&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span>  <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;nancy&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;fish&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">10</span><span style="color:#111">)</span> 
<span style="color:#111">)</span>
<span style="color:#00a8c8">select</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">from</span> <span style="color:#111">ownner_pet</span>
</code></pre></div><p>STRUCT は ARRAY の要素にするのがメインの使い方？？</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#f92672">#</span> <span style="color:#111">STRUCT</span> <span style="color:#960050;background-color:#1e0010">を要素に持つ</span> <span style="color:#111">ARRAY</span> <span style="color:#960050;background-color:#1e0010">カラム</span>
<span style="color:#00a8c8">WITH</span>
<span style="color:#111">ownner_pet</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">(</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;tony&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">[</span><span style="color:#111">STRUCT</span><span style="color:#111">(</span><span style="color:#d88200">&#39;dog&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#111">species</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">count</span><span style="color:#111">),</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;cat&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)]</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span> <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;tim&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">[(</span><span style="color:#d88200">&#39;cat&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">),</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;cow&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">),</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;horse&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">3</span><span style="color:#111">)]</span>  <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;nancy&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span>  <span style="color:#111">[(</span><span style="color:#d88200">&#39;fish&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">10</span><span style="color:#111">),</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;bird&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">),</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;horse&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">3</span><span style="color:#111">)]</span>
<span style="color:#111">)</span>
<span style="color:#00a8c8">select</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">from</span> <span style="color:#111">ownner_pet</span>
</code></pre></div></article>

      
<div class="book-footer justify-between">
  
  <div>
    
    <a class="flex align-center" href="https://github.com/teuder/notebook/commit/143e23f205f622d0de375a6908b9b245abd51749" title='Last modified 2021-09-10 by Masaki Tsuda' target="_blank" rel="noopener">
      <img src="/notebook/svg/calendar.svg" alt="Changed" />
      <span>2021-09-10</span>
    </a>
  </div>
  
  
  <div>
    
    <a class="flex align-center" href="https://github.com/teuder/notebook/edit/master/content/gcp/bigquery_sql.md" target="_blank" rel="noopener">
      <img src="/notebook/svg/edit.svg" alt="Edit" />
      <span>Edit this page</span>
    </a>
    
  </div>
  
</div>


      
    </div>

    
  

  <aside class="book-toc level-3 fixed">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#基本文法">基本文法</a></li>
    <li><a href="#レギュラーsqlをデフォルトにする">レギュラーSQLをデフォルトにする</a>
      <ul>
        <li><a href="#実数を丸める関数">実数を丸める関数</a></li>
        <li><a href="#行の抽出">行の抽出</a></li>
        <li><a href="#カラム名を取得する">カラム名を取得する</a></li>
      </ul>
    </li>
    <li><a href="#文字列">文字列</a>
      <ul>
        <li><a href="#部分文字列-substr">部分文字列: SUBSTR</a></li>
      </ul>
    </li>
    <li><a href="#日付">日付</a>
      <ul>
        <li><a href="#日付要素を取り出す">日付要素を取り出す</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#tablesample-句">TABLESAMPLE 句</a></li>
    <li><a href="#where-rand">WHERE rand()</a></li>
  </ul>

  <ul>
    <li><a href="#arrayの型">ARRAYの型</a></li>
    <li><a href="#array-を展開する-left-join-unnest-array">ARRAY を展開する LEFT JOIN UNNEST (array)</a></li>
    <li><a href="#where-in-unnest-array">WHERE IN UNNEST (array)</a></li>
    <li><a href="#where-exists--select--from-unnest-array-as-a-where-a--x">WHERE EXISTS ( SELECT * FROM UNNEST (array) as A WHERE A = &lsquo;X&rsquo;)</a></li>
    <li><a href="#array-から一部の要素を取り出す">ARRAY から一部の要素を取り出す</a></li>
    <li><a href="#udf-を使った-array-処理">UDF を使った ARRAY 処理</a></li>
    <li><a href="#番号を使った-array-要素へのアクセス">番号を使った ARRAY 要素へのアクセス</a></li>
    <li><a href="#arrayの要素の結合">ARRAYの要素の結合</a></li>
  </ul>
</nav>
  </aside>



  </main>

  
</body>

</html>
