<!DOCTYPE html><html>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>notebook</title>
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link href="https://fonts.googleapis.com/css?family=Archivo" rel="stylesheet"> 
<link href="https://fonts.googleapis.com/css?family=Barlow+Condensed" rel="stylesheet">
<script src="https://unpkg.com/lunr/lunr.js"></script>



<script src="/js/vendor/lunr.stemmer.support.js"></script>
<script src="/js/vendor/lunr.ja.js"></script>

<link rel="stylesheet" href="/notebook/normalize.min.css">

<link rel="stylesheet" href="/notebook/book.min.b0e8214cbf05079a2aba369158e0410c2515a8def4c0b44254eefada553ab758.css">

<!--
Made with Book Theme
https://github.com/hotosm/hugo-book
-->
  
</head>

<body>
  <header class="header-nav" id="nav">
    <div class="nav-container">
      <a class="nav-title with-logo" href="/">
        <img class="logo" src="https://teuder.github.io/notebook//svg/hot-logo-icon-white.svg" alt="humanitarian openstreetmap team logo">
        <span>notebook</span>
      </a>
      <a class="nav-guide-link guide-active" href="https://teuder.github.io/notebook/gis/bigquerygis/" >Guide</a>
      <div class="hr-v"></div>
      <a class="nav-pdf-download" 
      
      href="/pdfs/notebook.pdf">
      
      Download PDF &nbsp;
      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="15" viewBox="0 0 12 15">
        <g fill="none" fill-rule="evenodd" transform="translate(-4 -2)">
          <polygon points="0 0 20 0 20 20 0 20"/>
          <path fill="#D73F3F" fill-rule="nonzero" d="M15.8333333,7.5 L12.5,7.5 L12.5,2.5 L7.5,2.5 L7.5,7.5 L4.16666667,7.5 L10,13.3333333 L15.8333333,7.5 Z M4.16666667,15 L4.16666667,16.6666667 L15.8333333,16.6666667 L15.8333333,15 L4.16666667,15 Z"/>
        </g>
      </svg>
      </a>
      <input type="checkbox" style="display: none" id="menu-control" />      
    </div>
    <div class="nav-right">
    
    
    
    <div> <label for="search"></label> <input type="text" name="search" class="search-input" placeholder="Search…"></div>
    <div class="search-results">
      <ul class="results-list"></ul>
    </div>
    
    

    
    <div class="hr-v"></div>
    <a href="https://hotosm.org" class="hotosm-link">hotosm.org <img src="/svg/icon-external-red.svg" alt=""></a>
    </div>
  </header>
  <main class="flex container">

    <aside class="book-menu fixed">
      <nav role="navigation">




	

<a href="/" >Introduction</a>  

    


  
  
    
  
 
  
  <ul>
    

    
  </ul>
 
  
  <ul>
    

    
    <li>
      <a href="/notebook/python/bigquery/">
    BigQuery</a>
    </li>
    
    <li>
      <a href="/notebook/python/environment/">
    environment</a>
    </li>
    
    <li>
      <a href="/notebook/python/jupyter/">
    jupyter</a>
    </li>
    
    <li>
      <a href="/notebook/python/pandas/">
    Pandas</a>
    </li>
    
    <li>
      <a href="/notebook/python/vscode/">
    Python in VScode</a>
    </li>
    
    <li>
      <a href="/notebook/python/anaconda/">
    anaconda</a>
    </li>
    
  </ul>
 
  
  <ul>
    

    
    <li>
      <a href="/notebook/r/leaflet/">
    leaflet</a>
    </li>
    
    <li>
      <a href="/notebook/r/rhdf5/">
    rhdf5</a>
    </li>
    
    <li>
      <a href="/notebook/r/ggplot2/">
    ggplot2</a>
    </li>
    
    <li>
      <a href="/notebook/r/raster/">
    raster</a>
    </li>
    
    <li>
      <a href="/notebook/r/sf/">
    sf</a>
    </li>
    
    <li>
      <a href="/notebook/r/bigrquery/">
    bigrquery</a>
    </li>
    
    <li>
      <a href="/notebook/r/dplyr/">
    dplyr</a>
    </li>
    
    <li>
      <a href="/notebook/r/future/">
    future</a>
    </li>
    
    <li>
      <a href="/notebook/r/gganimate/">
    gganimate</a>
    </li>
    
    <li>
      <a href="/notebook/r/lubridate/">
    lubridate</a>
    </li>
    
    <li>
      <a href="/notebook/r/purrr/">
    purrr</a>
    </li>
    
    <li>
      <a href="/notebook/r/package_development/">
    R Package Development</a>
    </li>
    
    <li>
      <a href="/notebook/r/r_python/">
    R_Python</a>
    </li>
    
    <li>
      <a href="/notebook/r/reticulate/">
    reticulate</a>
    </li>
    
    <li>
      <a href="/notebook/r/rmarkdown/">
    Rmarkdown</a>
    </li>
    
    <li>
      <a href="/notebook/r/rpart/">
    rpart</a>
    </li>
    
    <li>
      <a href="/notebook/r/rstudio/">
    RStudio</a>
    </li>
    
    <li>
      <a href="/notebook/r/rvest/">
    rvest</a>
    </li>
    
    <li>
      <a href="/notebook/r/stars/">
    stars</a>
    </li>
    
    <li>
      <a href="/notebook/r/stringr/">
    stringr</a>
    </li>
    
    <li>
      <a href="/notebook/r/tidymodels/">
    tidymodels</a>
    </li>
    
    <li>
      <a href="/notebook/r/tidyr/">
    tidyr</a>
    </li>
    
    <li>
      <a href="/notebook/r/wk/">
    wk</a>
    </li>
    
    <li>
      <a href="/notebook/r/dbi/">
    DBI</a>
    </li>
    
  </ul>
 
  
  <ul>
    

    
    <li>
      <a href="/notebook/datascience/bayesian_statistics/">
    Bayesian Staistics</a>
    </li>
    
  </ul>
 
  
  <ul>
    

    
    <li>
      <a href="/notebook/gis/bigquerygis/">
    BigQuery GIS</a>
    </li>
    
    <li>
      <a href="/notebook/gis/sar/">
    SAR</a>
    </li>
    
    <li>
      <a href="/notebook/gis/terminology/">
    用語</a>
    </li>
    
    <li>
      <a href="/notebook/gis/viirs/">
    VIIRS</a>
    </li>
    
    <li>
      <a href="/notebook/gis/r_package/">
    GIS関連Rパッケージ</a>
    </li>
    
  </ul>
 
  
  <ul>
    

    
    <li>
      <a href="/notebook/mac/homebrew/">
    homebrew</a>
    </li>
    
  </ul>
 
  
  <ul>
    

    
    <li>
      <a href="/notebook/maritime/glossary/">
    glossary</a>
    </li>
    
  </ul>
 
  
  <ul>
    

    
    <li>
      <a href="/notebook/gcp/bigquery_gis/">
    BigQuery GIS</a>
    </li>
    
    <li>
      <a href="/notebook/gcp/bigquery_bq/">
    BigQuery: bqコマンド</a>
    </li>
    
    <li>
      <a href="/notebook/gcp/bigquery/">
    BigQuery: general</a>
    </li>
    
    <li>
      <a href="/notebook/gcp/bigquery_sql/" class="active">
    BigQuery: SQL</a>
    </li>
    
  </ul>
 
  
  <ul>
    

    
    <li>
      <a href="/notebook/miscellaneous/c_plus_plus/">
    C&#43;&#43;</a>
    </li>
    
    <li>
      <a href="/notebook/miscellaneous/english/">
    english</a>
    </li>
    
    <li>
      <a href="/notebook/miscellaneous/jinjia2/">
    jinja</a>
    </li>
    
    <li>
      <a href="/notebook/miscellaneous/jupyter/">
    jupyter</a>
    </li>
    
    <li>
      <a href="/notebook/miscellaneous/pc/">
    PC</a>
    </li>
    
    <li>
      <a href="/notebook/miscellaneous/tmux/">
    tmux</a>
    </li>
    
    <li>
      <a href="/notebook/miscellaneous/vscode/">
    vscode</a>
    </li>
    
    <li>
      <a href="/notebook/miscellaneous/windows/">
    Windows</a>
    </li>
    
    <li>
      <a href="/notebook/miscellaneous/wsl/">
    wsl</a>
    </li>
    
    <li>
      <a href="/notebook/miscellaneous/hugo/">
    Hugo</a>
    </li>
    
    <li>
      <a href="/notebook/miscellaneous/git/">
    git</a>
    </li>
    
  </ul>








</nav>
    </aside>

    <div class="book-page">
      <header class="align-center justify-between book-header">
  <label for="menu-control">
    <img src="/notebook/svg/menu.svg" />
  </label>
  <strong>
    BigQuery: SQL</strong>
</header>

      
<article class="markdown">
  <div class="markdown__header">  <h1>BigQuery: SQL</h1>
    <a 
    
    href="/pdfs/bigquery_sql.pdf"
    
    class="pdf-download-link"> Download page as PDF &nbsp;
      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="15" viewBox="0 0 12 15">
        <g fill="none" fill-rule="evenodd" transform="translate(-4 -2)">
          <polygon points="0 0 20 0 20 20 0 20"/>
          <path fill="#D73F3F" fill-rule="nonzero" d="M15.8333333,7.5 L12.5,7.5 L12.5,2.5 L7.5,2.5 L7.5,7.5 L4.16666667,7.5 L10,13.3333333 L15.8333333,7.5 Z M4.16666667,15 L4.16666667,16.6666667 L15.8333333,16.6666667 L15.8333333,15 L4.16666667,15 Z"/>
        </g>
      </svg>
    </a>
  </div><h1 id="bigquery-sql">BigQuery: SQL</h1>
<h2 id="基本文法">基本文法</h2>
<ul>
<li><a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/query-syntax">標準 SQL のクエリ構文</a></li>
<li><a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/operators?hl=ja">標準SQLの演算子</a></li>
<li><a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators?hl=ja">標準SQLの関数と演算子</a></li>
</ul>
<h2 id="レギュラーsqlをデフォルトにする">レギュラーSQLをデフォルトにする</h2>
<p>クエリの前に <code>#standardSQL</code> の記述を追加する。逆にレガシーにしたい場合は <code>#legacySQL</code> を記述する。</p>
<pre><code class="language-{sql}" data-lang="{sql}">#standardSQL
SELECT
  weight_pounds, state, year, gestation_weeks
FROM
  `bigquery-public-data.samples.natality`
ORDER BY weight_pounds DESC
LIMIT 10;
</code></pre><p><code>.bigqueryrc</code> に以下を記述</p>
<pre><code>[query]
--use_legacy_sql=false

[mk]
--use_legacy_sql=false
</code></pre><h2 id="実数を丸める関数">実数を丸める関数</h2>
<ul>
<li><code>ROUND()</code></li>
<li><code>CEILING()</code></li>
<li><code>FLOOR()</code></li>
<li><code>TRUNC()</code></li>
</ul>
<p><a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators?hl=ja#floor">丸め関数の挙動</a></p>
<p><img src="ceil_floor_trunc_round.jpeg" alt="Pythonの丸め関数の挙動、多分BigQueryと同じ" title="Pythonの丸め関数の挙動"></p>
<h2 id="行の抽出">行の抽出</h2>
<h3 id="where-column-in-sub_query-">WHERE column IN( sub_query )</h3>
<p>列の値が、サブクエリの出力結果と同じ値をもつ行だけを抽出する</p>
<pre><code>SELECT
  *
FROM
  tableA
WHERE
  item IN (
    SELECT
      product
    FROM
      tableB
  )
</code></pre><h3 id="where-exists-sub_query-">WHERE EXISTS( sub_query )</h3>
<p>サブクエリのなかのwhere句で抽出したいレコードの条件を指定する。</p>
<pre><code>SELECT
  *
FROM
  tableA
WHERE
  EXISTS (
    SELECT
      product
    FROM
      tableB
    WHERE
      tableA.item = tableB.product
      AND tableA.price = tableB.price
  )
</code></pre><h2 id="カラム名を取得する">カラム名を取得する</h2>
<pre><code>SELECT
  column_name
FROM
  dataset_name.INFORMATION_SCHEMA.COLUMNS
WHERE
  table_name = 'table_name'
</code></pre><p>カラム名を取得して、INSERT SELECT 用の文字列を生成する</p>
<pre><code>WITH ColumnNames AS (
  SELECT column_name  FROM scratch_masaki.INFORMATION_SCHEMA.COLUMNS
  WHERE table_name = 'viirs_ais_matching_20200101_masaki'
)
SELECT CONCAT(
  'INSERT dataset.tablename (',
  ARRAY_TO_STRING(ARRAY(SELECT column_name FROM ColumnNames), ', '),    
  ')');
</code></pre><h2 id="文字列">文字列</h2>
<h3 id="部分文字列-substr">部分文字列: SUBSTR</h3>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#111">SUBSTR</span><span style="color:#111">(</span><span style="color:#960050;background-color:#1e0010">カラム</span><span style="color:#111">,</span> <span style="color:#960050;background-color:#1e0010">開始位置</span> <span style="color:#111">[,</span><span style="color:#960050;background-color:#1e0010">長さ</span><span style="color:#111">])</span>
</code></pre></div><h2 id="日付">日付</h2>
<h3 id="日付要素を取り出す">日付要素を取り出す</h3>
<pre><code>EXTRACT(要素 FROM DATEカラム)
</code></pre><p>要素としては以下を指定できる</p>
<ul>
<li><code>DAY</code></li>
<li><code>MONTH</code></li>
<li><code>QUARTER</code>: 範囲 [1,4] 内の値</li>
<li><code>YEAR</code></li>
<li><code>DAYOFWEEK</code> 日曜が1, 土曜が7</li>
<li><code>DAYOFYEAR</code></li>
<li><code>WEEK</code>: 範囲 [0, 53] 内の日付の週番号を返します。週は日曜日から始まり、年の最初の日曜日より前の日付は 0 週目です</li>
<li><code>WEEK(&lt;WEEKDAY&gt;)</code>: 範囲 [0, 53] 内の日付の週番号を返します。週は WEEKDAY から始まります。最初の WEEKDAY より前の日付は、第 0 週になります。 <code>WEEKDAY</code> の有効な値は、SUNDAY、MONDAY、TUESDAY、WEDNESDAY、THURSDAY、FRIDAY、SATURDAY です。</li>
<li><code>ISOYEAR</code></li>
<li><code>ISOWEEK</code></li>
</ul>
<h2 id="ランダムサンプル">ランダムサンプル</h2>
<h3 id="tablesample-句">TABLESAMPLE 句</h3>
<p>10%のレコードを抽出する。</p>
<pre><code>SELECT * FROM dataset.my_table TABLESAMPLE SYSTEM (10 PERCENT)
</code></pre><p>注意：ただし、<code>TABLESAMPLE</code> を使った場合は、データの抽出は行ごとに行われるのではない。</p>
<p>大きいテーブルは「データブロック」と呼ばれる単位に分割されてで保存されているのだが、例えば、 <code>TABLESAMPLE SYSTEM (20 PERCENT)</code> とすると全体の 20% のデータブロックがランダムに抽出される。小さいテーブル（1GB未満）では１つのデータブロックに全てのデータが格納されるため、 <code>TABLESAMPLE</code> を使うと全てのデータが抽出される。</p>
<p>そこで、行ごとに厳密にランダムに抽出したいときは、次の　<code>WHERE rand()</code> を使用する。ただし、<code>WHERE rand()</code> を使用するとテーブル全体をスキャンするのでコストが大きくなることに注意する。<code>TABLESAMPLE</code> を使うとテーブル全体をスキャンしないのでクエリのコストは小さくなる。</p>
<h3 id="where-rand">WHERE rand()</h3>
<p>10%のレコードを抽出する。</p>
<pre><code>SELECT * FROM dataset.my_table WHERE rand() &lt; 0.1
</code></pre><p>ただし、 <code>WHERE rand()</code> を使用するとテーブル全体をスキャンするのでコストが大きくなることに注意する。<code>TABLESAMPLE</code> を使うとテーブル全体をスキャンしないのでクエリのコストは小さくなる。</p>
<h2 id="sharded-table">Sharded Table</h2>
<p>Sharded Table へのアクセス</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">SELECT</span> <span style="color:#111">ssvid</span>
<span style="color:#00a8c8">FROM</span>

<span style="color:#f92672">`</span><span style="color:#111">world</span><span style="color:#f92672">-</span><span style="color:#111">fishing</span><span style="color:#f92672">-</span><span style="color:#ae81ff">827</span><span style="color:#111">.</span><span style="color:#111">pipe_production_v20201001</span><span style="color:#111">.</span><span style="color:#111">messages_scored_</span><span style="color:#f92672">*`</span>

<span style="color:#00a8c8">WHERE</span> 
<span style="color:#111">_TABLE_SUFFIX</span>
<span style="color:#00a8c8">BETWEEN</span> <span style="color:#d88200">&#39;20200101&#39;</span> <span style="color:#00a8c8">AND</span> <span style="color:#d88200">&#39;20201231&#39;</span>
</code></pre></div><h2 id="array">ARRAY</h2>
<h3 id="arrayの型">ARRAYの型</h3>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">
<span style="color:#00a8c8">SELECT</span>
  <span style="color:#111">ARRAY</span><span style="color:#f92672">&lt;</span><span style="color:#111">INT64</span><span style="color:#f92672">&gt;</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span><span style="color:#ae81ff">2</span><span style="color:#111">,</span><span style="color:#ae81ff">3</span><span style="color:#111">],</span>
  <span style="color:#111">ARRAY</span><span style="color:#f92672">&lt;</span><span style="color:#111">STRUCT</span><span style="color:#f92672">&lt;</span><span style="color:#111">INT64</span><span style="color:#111">,</span> <span style="color:#111">INT64</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#111">,</span>
  <span style="color:#f92672">#</span> <span style="color:#111">ARRAY</span><span style="color:#f92672">&lt;</span><span style="color:#111">ARRAY</span><span style="color:#f92672">&lt;</span><span style="color:#111">INT64</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#111">[[</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span><span style="color:#ae81ff">2</span><span style="color:#111">],[</span><span style="color:#ae81ff">3</span><span style="color:#111">,</span><span style="color:#ae81ff">4</span><span style="color:#111">,],[</span><span style="color:#ae81ff">5</span><span style="color:#111">,</span><span style="color:#ae81ff">6</span><span style="color:#111">]],</span> <span style="color:#f92672">#</span> <span style="color:#111">ARRAYを要素に持つARRAYは作成できない</span>
  <span style="color:#111">ARRAY</span><span style="color:#f92672">&lt;</span><span style="color:#111">STRUCT</span><span style="color:#f92672">&lt;</span><span style="color:#111">ARRAY</span><span style="color:#f92672">&lt;</span><span style="color:#111">INT64</span><span style="color:#f92672">&gt;&gt;&gt;</span><span style="color:#111">,</span>　             <span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">その代わりに</span> <span style="color:#111">ARRAYをSTRUCTで包めばそれを</span><span style="color:#960050;background-color:#1e0010">、</span><span style="color:#111">ARRAYとして格納できる</span>

</code></pre></div><p><a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/arrays">https://cloud.google.com/bigquery/docs/reference/standard-sql/arrays</a></p>
<h3 id="array-の作成">ARRAY の作成</h3>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">WITH</span>
<span style="color:#111">ownner_pet</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">(</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;tony&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">[</span><span style="color:#d88200">&#39;dog&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;cat&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span> <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;tim&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">[</span><span style="color:#d88200">&#39;cat&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;bird&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span> <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;nancy&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">[</span><span style="color:#d88200">&#39;dog&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;fish&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;lizard&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span> <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span>
<span style="color:#111">)</span>

</code></pre></div><p>pet は arrayとする。</p>
<p><code>ownner_pet</code> table</p>
<table>
<thead>
<tr>
<th>owner</th>
<th>pet</th>
</tr>
</thead>
<tbody>
<tr>
<td>tony</td>
<td>dog</td>
</tr>
<tr>
<td></td>
<td>cat</td>
</tr>
<tr>
<td>tim</td>
<td>cat</td>
</tr>
<tr>
<td></td>
<td>bird</td>
</tr>
<tr>
<td>nancy</td>
<td>dog</td>
</tr>
<tr>
<td></td>
<td>fish</td>
</tr>
<tr>
<td></td>
<td>lizard</td>
</tr>
</tbody>
</table>
<h3 id="array-を展開する-left-join-unnest-array">ARRAY を展開する LEFT JOIN UNNEST (array)</h3>
<p><code>LEFT JOIN UNNEST (array)</code> を使用する</p>
<p>下の例では <code>ais_identity.n_imo</code> が <code>array</code></p>
<p>これをすると、 <code>ais_identity.n_imo is null</code> の行は除外される</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">select</span>
  <span style="color:#111">ssvid</span><span style="color:#111">,</span>
  <span style="color:#111">best</span><span style="color:#111">.</span><span style="color:#111">best_flag</span><span style="color:#111">,</span>
  <span style="color:#111">ais_identity</span><span style="color:#111">.</span><span style="color:#111">flag_mmsi</span><span style="color:#111">,</span>
  <span style="color:#111">best</span><span style="color:#111">.</span><span style="color:#111">best_vessel_class</span><span style="color:#111">,</span>
  <span style="color:#111">ais_identity</span><span style="color:#111">.</span><span style="color:#111">n_shipname</span><span style="color:#111">,</span>
  <span style="color:#111">ais_identity</span><span style="color:#111">.</span><span style="color:#111">n_callsign</span><span style="color:#111">,</span>
  <span style="color:#111">n_imo</span><span style="color:#111">.</span><span style="color:#111">value</span> <span style="color:#00a8c8">as</span> <span style="color:#111">n_imo_value</span><span style="color:#111">,</span>
  <span style="color:#111">n_imo</span><span style="color:#111">.</span><span style="color:#00a8c8">count</span> <span style="color:#00a8c8">as</span> <span style="color:#111">n_imo_count</span><span style="color:#111">,</span>
  <span style="color:#111">n_imo</span><span style="color:#111">.</span><span style="color:#00a8c8">type</span> <span style="color:#00a8c8">as</span> <span style="color:#111">n_imo_type</span>
<span style="color:#00a8c8">from</span>
<span style="color:#f92672">`</span><span style="color:#111">world</span><span style="color:#f92672">-</span><span style="color:#111">fishing</span><span style="color:#f92672">-</span><span style="color:#ae81ff">827</span><span style="color:#111">.</span><span style="color:#111">gfw_research</span><span style="color:#111">.</span><span style="color:#111">vi_ssvid_v20200801</span><span style="color:#f92672">`</span>
<span style="color:#00a8c8">LEFT</span> <span style="color:#00a8c8">JOIN</span> <span style="color:#00a8c8">UNNEST</span><span style="color:#111">(</span><span style="color:#111">ais_identity</span><span style="color:#111">.</span><span style="color:#111">n_imo</span> <span style="color:#111">)</span> <span style="color:#00a8c8">as</span> <span style="color:#111">n_imo</span>
</code></pre></div><h3 id="where-in-unnest-array">WHERE IN UNNEST (array)</h3>
<p>Array の要素として特定の値が含まれるレコードを抽出する</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">SELECT</span>
  <span style="color:#f92672">*</span>
<span style="color:#00a8c8">FROM</span>
  <span style="color:#111">ownner_pet</span>
<span style="color:#00a8c8">WHERE</span> <span style="color:#00a8c8">IN</span> <span style="color:#00a8c8">UNNEST</span> <span style="color:#111">(</span><span style="color:#111">pet</span><span style="color:#111">)</span>
</code></pre></div><h3 id="where-exists--select--from-unnest-array-as-a-where-a--x">WHERE EXISTS ( SELECT * FROM UNNEST (array) as A WHERE A = &lsquo;X&rsquo;)</h3>
<p>Array が特定の条件を満たすレコードを抽出する <code>IN UNNEST</code> でよりも複雑な条件を指定することができる。</p>
<p>この例は　<code>IN UNNEST</code>　と同じ結果を返すけど、ARRAYの要素が STRUCT 等の場合や、もっと複雑な条件を指定したい場合は <code>WHERE EXIST</code> を使う</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">SELECT</span>
  <span style="color:#f92672">*</span>
<span style="color:#00a8c8">FROM</span>
  <span style="color:#111">ownner_pet</span>
<span style="color:#00a8c8">WHERE</span> <span style="color:#00a8c8">EXISTS</span> <span style="color:#111">(</span>
  <span style="color:#00a8c8">SELECT</span> <span style="color:#f92672">*</span>
  <span style="color:#00a8c8">FROM</span> <span style="color:#00a8c8">UNNEST</span> <span style="color:#111">(</span><span style="color:#111">pat</span><span style="color:#111">)</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">p</span>
  <span style="color:#00a8c8">WHERE</span> <span style="color:#111">p</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#39;bear&#39;</span>
<span style="color:#111">)</span>
</code></pre></div><h3 id="array-から一部の要素を取り出す">ARRAY から一部の要素を取り出す</h3>
<p>結果は元のテーブルの形式を保持したまま、一部の ARRAY 要素を取り出す</p>
<pre><code>WITH
ownner_pet AS (
SELECT 'tony' as owner, ['dog', 'cat'] as pet UNION ALL
SELECT 'tim' as owner, ['cat', 'bird'] as pet UNION ALL
SELECT 'nancy' as owner, ['dog', 'fish', 'lizard'] as pet 
)

SELECT
  owner,
  ARRAY (SELECT p FROM UNNEST (pet) as p WHERE p LIKE 'c%' ) as pet
FROM
  ownner_pet

</code></pre><h3 id="array-の要素のソート">ARRAY の要素のソート</h3>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#f92672">#</span> <span style="color:#111">STRING</span> <span style="color:#960050;background-color:#1e0010">を要素に持つ</span> <span style="color:#111">ARRAY</span> <span style="color:#960050;background-color:#1e0010">カラム</span>
<span style="color:#00a8c8">WITH</span>
<span style="color:#111">ownner_pet</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">(</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;tony&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">[</span><span style="color:#d88200">&#39;dog&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;cat&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span> <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;tim&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">[</span><span style="color:#d88200">&#39;cat&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;bird&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span> <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;nancy&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">[</span><span style="color:#d88200">&#39;dog&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;fish&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;lizard&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span> 
<span style="color:#111">)</span>

<span style="color:#00a8c8">SELECT</span>
  <span style="color:#00a8c8">owner</span><span style="color:#111">,</span>
  <span style="color:#111">ARRAY</span> <span style="color:#111">(</span><span style="color:#00a8c8">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">FROM</span> <span style="color:#00a8c8">UNNEST</span> <span style="color:#111">(</span><span style="color:#111">pet</span><span style="color:#111">)</span> <span style="color:#00a8c8">as</span> <span style="color:#111">p</span> <span style="color:#00a8c8">ORDER</span> <span style="color:#00a8c8">BY</span> <span style="color:#111">p</span> <span style="color:#111">)</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span>
<span style="color:#00a8c8">FROM</span>
  <span style="color:#111">ownner_pet</span>
</code></pre></div><div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#f92672">#</span> <span style="color:#111">STRUCT</span> <span style="color:#960050;background-color:#1e0010">を要素に持つ</span> <span style="color:#111">ARRAY</span> <span style="color:#960050;background-color:#1e0010">カラム</span>
<span style="color:#00a8c8">WITH</span>
<span style="color:#111">ownner_pet</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">(</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;tony&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">[</span><span style="color:#111">STRUCT</span><span style="color:#111">(</span><span style="color:#d88200">&#39;dog&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#111">species</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">count</span><span style="color:#111">),</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;cat&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)]</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span> <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;tim&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">[(</span><span style="color:#d88200">&#39;cat&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">),</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;cow&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">),</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;horse&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">3</span><span style="color:#111">)]</span>  <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;nancy&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span>  <span style="color:#111">[(</span><span style="color:#d88200">&#39;fish&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">10</span><span style="color:#111">),</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;bird&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">),</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;horse&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">3</span><span style="color:#111">)]</span>
<span style="color:#111">)</span>


<span style="color:#00a8c8">SELECT</span>
  <span style="color:#00a8c8">owner</span><span style="color:#111">,</span>
  <span style="color:#111">ARRAY</span> <span style="color:#111">(</span><span style="color:#00a8c8">SELECT</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">STRUCT</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">FROM</span> <span style="color:#00a8c8">UNNEST</span> <span style="color:#111">(</span><span style="color:#111">pet</span><span style="color:#111">)</span> <span style="color:#00a8c8">as</span> <span style="color:#111">p</span> <span style="color:#00a8c8">ORDER</span> <span style="color:#00a8c8">BY</span> <span style="color:#111">p</span><span style="color:#111">.</span><span style="color:#00a8c8">count</span><span style="color:#111">,</span> <span style="color:#111">p</span><span style="color:#111">.</span><span style="color:#111">species</span><span style="color:#111">)</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span>
<span style="color:#00a8c8">FROM</span>
  <span style="color:#111">ownner_pet</span>

</code></pre></div><h3 id="udf-を使った-array-処理">UDF を使った ARRAY 処理</h3>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">FUNCTION</span> <span style="color:#111">SORT_ARRAY</span><span style="color:#111">(</span><span style="color:#111">arr</span> <span style="color:#00a8c8">ANY</span> <span style="color:#00a8c8">TYPE</span><span style="color:#111">,</span> <span style="color:#111">ascending</span> <span style="color:#111">BOOL</span><span style="color:#111">)</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">(</span>
<span style="color:#00a8c8">IF</span> <span style="color:#111">(</span><span style="color:#111">ascending</span><span style="color:#111">,</span>
    <span style="color:#111">ARRAY</span> <span style="color:#111">(</span><span style="color:#00a8c8">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">FROM</span> <span style="color:#00a8c8">UNNEST</span> <span style="color:#111">(</span><span style="color:#111">arr</span><span style="color:#111">)</span> <span style="color:#111">a</span> <span style="color:#00a8c8">ORDER</span> <span style="color:#00a8c8">BY</span> <span style="color:#111">a</span><span style="color:#111">),</span>
    <span style="color:#111">ARRAY</span> <span style="color:#111">(</span><span style="color:#00a8c8">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">FROM</span> <span style="color:#00a8c8">UNNEST</span> <span style="color:#111">(</span><span style="color:#111">arr</span><span style="color:#111">)</span> <span style="color:#111">a</span> <span style="color:#00a8c8">ORDER</span> <span style="color:#00a8c8">BY</span> <span style="color:#111">a</span> <span style="color:#00a8c8">DESC</span><span style="color:#111">)</span> <span style="color:#111">)</span>
<span style="color:#111">);</span>


<span style="color:#00a8c8">WITH</span>
<span style="color:#111">ownner_pet</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">(</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;tony&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">[</span><span style="color:#d88200">&#39;dog&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;cat&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span> <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;tim&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">[</span><span style="color:#d88200">&#39;cat&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;bird&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span> <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;nancy&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">[</span><span style="color:#d88200">&#39;dog&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;fish&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;lizard&#39;</span><span style="color:#111">]</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span> 
<span style="color:#111">)</span>

<span style="color:#00a8c8">SELECT</span>
  <span style="color:#00a8c8">owner</span><span style="color:#111">,</span>
  <span style="color:#111">SORT_ARRAY</span><span style="color:#111">(</span><span style="color:#111">pet</span><span style="color:#111">,</span> <span style="color:#00a8c8">TRUE</span><span style="color:#111">)</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span>
<span style="color:#00a8c8">FROM</span>
  <span style="color:#111">ownner_pet</span>

</code></pre></div><h3 id="番号を使った-array-要素へのアクセス">番号を使った ARRAY 要素へのアクセス</h3>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">WITH</span> <span style="color:#111">sequences</span> <span style="color:#00a8c8">AS</span>
  <span style="color:#111">(</span><span style="color:#00a8c8">SELECT</span> <span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">,</span> <span style="color:#ae81ff">5</span><span style="color:#111">]</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">some_numbers</span>
   <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span> <span style="color:#00a8c8">SELECT</span> <span style="color:#111">[</span><span style="color:#ae81ff">2</span><span style="color:#111">,</span> <span style="color:#ae81ff">4</span><span style="color:#111">,</span> <span style="color:#ae81ff">8</span><span style="color:#111">,</span> <span style="color:#ae81ff">16</span><span style="color:#111">,</span> <span style="color:#ae81ff">32</span><span style="color:#111">]</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">some_numbers</span>
   <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span> <span style="color:#00a8c8">SELECT</span> <span style="color:#111">[</span><span style="color:#ae81ff">5</span><span style="color:#111">,</span> <span style="color:#ae81ff">10</span><span style="color:#111">]</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">some_numbers</span><span style="color:#111">)</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#111">some_numbers</span><span style="color:#111">,</span>
       <span style="color:#111">some_numbers</span><span style="color:#111">[</span><span style="color:#00a8c8">OFFSET</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)]</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">offset_1</span><span style="color:#111">,</span>
       <span style="color:#111">some_numbers</span><span style="color:#111">[</span><span style="color:#111">ORDINAL</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)]</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">ordinal_1</span>
<span style="color:#00a8c8">FROM</span> <span style="color:#111">sequences</span><span style="color:#111">;</span>
</code></pre></div><h2 id="arrayの要素の結合">ARRAYの要素の結合</h2>
<p>ARRAY_CONCAT() のような関数を使用して複数の配列を結合し、ARRAY_TO_STRING() を使用して配列を文字列に変換できます。</p>
<h2 id="user-defined-functions">User Defined Functions</h2>
<pre><code># 定数をUDFとして保存する
CREATE TEMP FUNCTION START_DATE() AS (TIMESTAMP('2012-04-01'));

# 使い捨て関数
CREATE TEMP FUNCTION SORT_ARRAY(arr ANY TYPE, ascending BOOL) AS (
IF (ascending,
    ARRAY (SELECT * FROM UNNEST (arr) a ORDER BY a),
    ARRAY (SELECT * FROM UNNEST (arr) a ORDER BY a DESC) )
);


# テーブルを作成するときと同じようにUDFを保存することもできる
CREATE OR REPLACE FUNCTION `your_project.your_dataset.SORT_ARRAY`(arr ANY TYPE, ascending BOOL) AS (
IF (ascending,
    ARRAY (SELECT * FROM UNNEST (arr) a ORDER BY a),
    ARRAY (SELECT * FROM UNNEST (arr) a ORDER BY a DESC) )
);
</code></pre><h2 id="struct">STRUCT</h2>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#f92672">#</span> <span style="color:#111">STRUCT</span> <span style="color:#960050;background-color:#1e0010">を要素に持つカラム</span>
<span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">これだと</span><span style="color:#111">structとしてまとめる意義があまりないかも</span>
<span style="color:#00a8c8">WITH</span>
<span style="color:#111">ownner_pet</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">(</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;tony&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">STRUCT</span><span style="color:#111">(</span><span style="color:#d88200">&#39;dog&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#111">species</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">count</span><span style="color:#111">)</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span> <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;tim&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;cat&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span>  <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;nancy&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;fish&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">10</span><span style="color:#111">)</span> 
<span style="color:#111">)</span>
<span style="color:#00a8c8">select</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">from</span> <span style="color:#111">ownner_pet</span>
</code></pre></div><p>STRUCT は ARRAY の要素にするのがメインの使い方？？</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#f92672">#</span> <span style="color:#111">STRUCT</span> <span style="color:#960050;background-color:#1e0010">を要素に持つ</span> <span style="color:#111">ARRAY</span> <span style="color:#960050;background-color:#1e0010">カラム</span>
<span style="color:#00a8c8">WITH</span>
<span style="color:#111">ownner_pet</span> <span style="color:#00a8c8">AS</span> <span style="color:#111">(</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;tony&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">[</span><span style="color:#111">STRUCT</span><span style="color:#111">(</span><span style="color:#d88200">&#39;dog&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#111">species</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">count</span><span style="color:#111">),</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;cat&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)]</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pet</span> <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;tim&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span> <span style="color:#111">[(</span><span style="color:#d88200">&#39;cat&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">),</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;cow&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">),</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;horse&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">3</span><span style="color:#111">)]</span>  <span style="color:#00a8c8">UNION</span> <span style="color:#00a8c8">ALL</span>
<span style="color:#00a8c8">SELECT</span> <span style="color:#d88200">&#39;nancy&#39;</span> <span style="color:#00a8c8">as</span> <span style="color:#00a8c8">owner</span><span style="color:#111">,</span>  <span style="color:#111">[(</span><span style="color:#d88200">&#39;fish&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">10</span><span style="color:#111">),</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;bird&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">),</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;horse&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">3</span><span style="color:#111">)]</span>
<span style="color:#111">)</span>
<span style="color:#00a8c8">select</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">from</span> <span style="color:#111">ownner_pet</span>
</code></pre></div><h1 id="window関数の結果でフィルター-qualify">WINDOW関数の結果でフィルター QUALIFY</h1>
<pre><code>
SELECT
    date,
    lat_bin,
    lon_bin,
    OrbitNumber,
    AVG(SATZ_GDNBO) as angle,
    # WINDOW FUNCITON
    RANK() OVER (PARTITION BY date, lat_bin, lon_bin ORDER BY AVG(SATZ_GDNBO)) AS rank
FROM 
    viirs
GROUP BY 
    date, lat_bin, lon_bin, OrbitNumber
QUALIFY
    # Extract records having minimum AVG(SATZ_GDNBO)
    rank = 1
)
</code></pre><h1 id="record型">RECORD型</h1>
<p>構造体のように複数の型の値を１つにまとめる。</p>
<p>Type: RECORD型
Mode: NULLABLE</p>
<p>モードが <code>NULLABLE</code> なら1行につき1行の値しか持たない、この場合は identity.ssvid という列があるだけと思って問題ない</p>
<p>identity	RECORD	NULLABLE
ssvid	STRING	NULLABLE
MMSI (Maritime Mobile Service Identity) as source specific vessel ID (SSVID)
n_shipname	STRING	NULLABLE
Ship name recorded in AIS messages (normalized)
n_callsign	STRING	NULLABLE
International Radio Call Sign recorded in AIS (normalized)
imo	STRING	NULLABLE
Identity number given by the International Maritime Organization
flag</p>
<p>モードが <code>REPEATED</code> なら、1行につき複数行を持つ、展開するには <code>LEFT JOIN UNNEST</code> を使う。結果的に行数は増える。</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00a8c8">SELECT</span> 
  <span style="color:#111">matched</span><span style="color:#111">,</span>
  <span style="color:#f92672">#</span> <span style="color:#00a8c8">identity</span> <span style="color:#960050;background-color:#1e0010">は</span> <span style="color:#00a8c8">NULLABLE</span> <span style="color:#960050;background-color:#1e0010">なので</span> <span style="color:#111">.</span> <span style="color:#960050;background-color:#1e0010">を使ってアクセスできる。</span>
  <span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">行数も増えない</span>
  <span style="color:#00a8c8">identity</span><span style="color:#111">.</span><span style="color:#111">ssvid</span><span style="color:#111">,</span>
  <span style="color:#00a8c8">identity</span><span style="color:#111">.</span><span style="color:#111">n_shipname</span><span style="color:#111">,</span>
  <span style="color:#f92672">#</span> <span style="color:#111">activity</span> <span style="color:#960050;background-color:#1e0010">の要素へのアクセス</span>
  <span style="color:#111">a</span><span style="color:#111">.</span><span style="color:#111">first_timestamp</span>
<span style="color:#00a8c8">FROM</span>
  <span style="color:#f92672">`</span><span style="color:#111">world</span><span style="color:#f92672">-</span><span style="color:#111">fishing</span><span style="color:#f92672">-</span><span style="color:#ae81ff">827</span><span style="color:#111">.</span><span style="color:#111">vessel_database</span><span style="color:#111">.</span><span style="color:#111">all_vessels_v20211001</span><span style="color:#f92672">`</span>
  <span style="color:#f92672">#</span> <span style="color:#111">activity</span> <span style="color:#960050;background-color:#1e0010">は</span> <span style="color:#111">REPEATED</span> <span style="color:#960050;background-color:#1e0010">なので</span> <span style="color:#00a8c8">LEFT</span> <span style="color:#00a8c8">JOIN</span> <span style="color:#00a8c8">UNNEST</span> <span style="color:#960050;background-color:#1e0010">で展開する</span>
  <span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">行数が増える</span>
  <span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">これは自分に自分を</span> <span style="color:#00a8c8">LEFT</span> <span style="color:#00a8c8">JOIN</span> <span style="color:#960050;background-color:#1e0010">しているのでテーブル名が省略される</span>
   <span style="color:#00a8c8">LEFT</span> <span style="color:#00a8c8">JOIN</span> <span style="color:#00a8c8">UNNEST</span><span style="color:#111">(</span><span style="color:#111">activity</span><span style="color:#111">)</span> <span style="color:#111">a</span>
<span style="color:#00a8c8">WHERE</span>
  <span style="color:#00a8c8">identity</span><span style="color:#111">.</span><span style="color:#111">ssvid</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#39;353154000&#39;</span>
</code></pre></div><h1 id="行の抽出-1">行の抽出</h1>
<p>WHERE
EXIST
HAVING
QUALIFY</p>
<p>array (selsct distinct as struct from unnest(registry) where list_uvi like &ldquo;iccat&rdquo;) as registry</p>
<p>from all_vessels</p>
<p>where array_length(registory) &gt;0</p>
<h1 id="json">JSON</h1>
<pre><code># 値を文字列として抽出
JSON_EXTRACT(列, &quot;$.要素名&quot;)
# 値を整数として抽
JSON_EXTRACT_SCALAR(列, &quot;$.要素名&quot;)
</code></pre></article>

      
<div class="align-center book-git-footer justify-between">
    
  <div>
    <a href="https://github.com/teuder/notebookedit/master/contentgcp/bigquery_sql.md" target="_blank" rel="noopener">
       Edit this page on GitHub
    </a>
  </div>
  
  
  <div>
    <a href="https://github.com/teuder/notebook/commit/166df44b38019783d66eba83ceba41fa63d852cd" title='Last modified February 16, 2022 19:06 JST by Masaki Tsuda' target="_blank" rel="noopener">
      <strong>Last Modified:</strong> Feb 16, 2022
    </a>
  </div>
  

</div>


    </div>

    
  
  
  <aside class="book-toc fixed">
    
      
    <nav id="TableOfContents">
  <ul>
    <li><a href="#基本文法">基本文法</a></li>
    <li><a href="#レギュラーsqlをデフォルトにする">レギュラーSQLをデフォルトにする</a></li>
    <li><a href="#実数を丸める関数">実数を丸める関数</a></li>
    <li><a href="#行の抽出">行の抽出</a>
      <ul>
        <li><a href="#where-column-in-sub_query-">WHERE column IN( sub_query )</a></li>
        <li><a href="#where-exists-sub_query-">WHERE EXISTS( sub_query )</a></li>
      </ul>
    </li>
    <li><a href="#カラム名を取得する">カラム名を取得する</a></li>
    <li><a href="#文字列">文字列</a>
      <ul>
        <li><a href="#部分文字列-substr">部分文字列: SUBSTR</a></li>
      </ul>
    </li>
    <li><a href="#日付">日付</a>
      <ul>
        <li><a href="#日付要素を取り出す">日付要素を取り出す</a></li>
      </ul>
    </li>
    <li><a href="#ランダムサンプル">ランダムサンプル</a>
      <ul>
        <li><a href="#tablesample-句">TABLESAMPLE 句</a></li>
        <li><a href="#where-rand">WHERE rand()</a></li>
      </ul>
    </li>
    <li><a href="#sharded-table">Sharded Table</a></li>
    <li><a href="#array">ARRAY</a>
      <ul>
        <li><a href="#arrayの型">ARRAYの型</a></li>
        <li><a href="#array-の作成">ARRAY の作成</a></li>
        <li><a href="#array-を展開する-left-join-unnest-array">ARRAY を展開する LEFT JOIN UNNEST (array)</a></li>
        <li><a href="#where-in-unnest-array">WHERE IN UNNEST (array)</a></li>
        <li><a href="#where-exists--select--from-unnest-array-as-a-where-a--x">WHERE EXISTS ( SELECT * FROM UNNEST (array) as A WHERE A = &lsquo;X&rsquo;)</a></li>
        <li><a href="#array-から一部の要素を取り出す">ARRAY から一部の要素を取り出す</a></li>
        <li><a href="#array-の要素のソート">ARRAY の要素のソート</a></li>
        <li><a href="#udf-を使った-array-処理">UDF を使った ARRAY 処理</a></li>
        <li><a href="#番号を使った-array-要素へのアクセス">番号を使った ARRAY 要素へのアクセス</a></li>
      </ul>
    </li>
    <li><a href="#arrayの要素の結合">ARRAYの要素の結合</a></li>
    <li><a href="#user-defined-functions">User Defined Functions</a></li>
    <li><a href="#struct">STRUCT</a></li>
  </ul>
</nav>
    
  </aside>



  </main>

  
  
  <footer class="footer">

    <p>Humanitarian OpenStreetMap Team is a 501(c)(3) not-for-profit organization and global community. Learn more about &nbsp;<a href="https://www.openstreetmap.org/about">OpenStreetMap</a>.</p>
    <a href="https://github.com/teuder/notebook" class="github-link">Contribute <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
      <path fill="#D73F3F" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
    </svg></a>
    

  </footer>
  
  <script src="/js/search.js"></script>
  

  
</body>

</html>
