<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"><meta property="og:title" content="tidymodels" />
<meta property="og:description" content="tidymodels tidymodels は統一的なインターフェースでモデリングを行うための、いくつかのパッケージをまとめたもの。 rsample ：訓練データ/テストデータの分割 recipe ：特徴量エン" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://teuder.github.io/notebook/r/tidymodels/" />

<title>tidymodels | notebook</title>
<link rel="icon" href="/notebook/favicon.png" type="image/x-icon">


<link rel="stylesheet" href="/notebook/book.min.07c38dce7b6800da2a75a565d4d975e38f837294e24d00b5aae363037012d64b.css" integrity="sha256-B8ONzntoANoqdaVl1Nl144&#43;DcpTiTQC1quNjA3AS1ks=">


<script defer src="/notebook/search.min.7b981e934dac4a66555d947655caed34144a61c211523d55903f78ca9630f2f1.js" integrity="sha256-e5gek02sSmZVXZR2VcrtNBRKYcIRUj1VkD94ypYw8vE="></script>

<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="flex container">

    <aside class="book-menu fixed">
      <nav>
<h2 class="book-brand">
  <a href="https://teuder.github.io/notebook/"><span>notebook</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" placeholder="Search" id="book-search-input" maxlength="64" />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>





    

  






  <ul>
  
    

  <li >
    
      

  <a href="/notebook/docs/" >
      About
  </a>


    

    




  
  <ul>
    
  </ul>
  



  </li>


  
    

  <li >
    
      

  <a href="/notebook/python/" >
      Python
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/notebook/python/environment/" >
      environment
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/python/jupyter/" >
      jupyter
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/python/vscode/" >
      Python in VScode
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/python/anaconda/" >
      anaconda
  </a>

</li>
      
    
  </ul>
  



  </li>


  
    

  <li >
    
      

  <a href="/notebook/r/" >
      R
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/notebook/r/leaflet/" >
      leaflet
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/rhdf5/" >
      rhdf5
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/ggplot2/" >
      ggplot2
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/raster/" >
      raster
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/sf/" >
      sf
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/bigrquery/" >
      bigrquery
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/dplyr/" >
      dplyr
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/future/" >
      future
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/gganimate/" >
      gganimate
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/lubridate/" >
      lubridate
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/purrr/" >
      purrr
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/package_development/" >
      R Package Development
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/reticulate/" >
      reticulate
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/rmarkdown/" >
      Rmarkdown
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/rpart/" >
      rpart
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/rstudio/" >
      RStudio
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/stars/" >
      stars
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/tidymodels/"  class="active">
      tidymodels
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/wk/" >
      wk
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/r/dbi/" >
      DBI
  </a>

</li>
      
    
  </ul>
  



  </li>


  
    

  <li >
    
      

  <a href="/notebook/datascience/" >
      Data Science
  </a>


    

    




  
  <ul>
    
  </ul>
  



  </li>


  
    

  <li >
    
      

  <a href="/notebook/gis/" >
      GIS &amp; Remote Sensing
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/notebook/gis/bigquerygis/" >
      BigQuery GIS
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/gis/sar/" >
      SAR
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/gis/terminology/" >
      用語
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/gis/viirs/" >
      VIIRS
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/gis/r_package/" >
      GIS関連Rパッケージ
  </a>

</li>
      
    
  </ul>
  



  </li>


  
    

  <li >
    
      

  <a href="/notebook/mac/" >
      Mac
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/notebook/mac/homebrew/" >
      homebrew
  </a>

</li>
      
    
  </ul>
  



  </li>


  
    

  <li >
    
      

  <a href="/notebook/maritime/" >
      Maritime
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/notebook/maritime/glossary/" >
      glossary
  </a>

</li>
      
    
  </ul>
  



  </li>


  
    

  <li >
    
      

  <a href="/notebook/gcp/" >
      Google Cloud Platform
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/notebook/gcp/bigquery_gis/" >
      BigQuery GIS
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/gcp/bigquery_bq/" >
      BigQuery: bqコマンド
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/gcp/bigquery/" >
      BigQuery: general
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/gcp/bigquery_sql/" >
      BigQuery: SQL
  </a>

</li>
      
    
  </ul>
  



  </li>


  
    

  <li >
    
      

  <a href="/notebook/miscellaneous/" >
      miscellaneous
  </a>


    

    




  
  <ul>
    
      
        <li>

  <a href="/notebook/miscellaneous/english/" >
      english
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/miscellaneous/jinjia2/" >
      jinja
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/miscellaneous/jupyter/" >
      jupyter
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/miscellaneous/pc/" >
      PC
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/miscellaneous/vscode/" >
      vscode
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/miscellaneous/windows/" >
      Windows
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/miscellaneous/hugo/" >
      Hugo
  </a>

</li>
      
    
      
        <li>

  <a href="/notebook/miscellaneous/git/" >
      git
  </a>

</li>
      
    
  </ul>
  



  </li>


  
  </ul>











</nav>


<script>
(function() {
  var menu = document.querySelector("aside.book-menu nav");
  addEventListener("beforeunload", function(event) {
    localStorage.setItem("menu.scrollTop", menu.scrollTop);
  });
  menu.scrollTop = localStorage.getItem("menu.scrollTop");
})();
</script>

    </aside>

    <div class="book-page">
      <header class="flex align-center justify-between book-header">
  <label for="menu-control">
    <img src="/notebook/svg/menu.svg" alt="Menu" />
  </label>
  <strong>tidymodels</strong>
</header>

      
<article class="markdown"><h1 id="tidymodels">tidymodels</h1>
<p><code>tidymodels</code> は統一的なインターフェースでモデリングを行うための、いくつかのパッケージをまとめたもの。</p>
<ul>
<li><code>rsample</code> ：訓練データ/テストデータの分割</li>
<li><code>recipe</code> ：特徴量エンジニアリング</li>
<li><code>parsnip</code> ：モデリング</li>
<li><code>yardstic</code> ：モデルの精度評価</li>
</ul>
<h1 id="データ加工">データ加工</h1>
<h2 id="traintest-分割">Train/Test 分割</h2>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75af00">set.seed</span><span style="color:#111">(</span><span style="color:#ae81ff">10</span><span style="color:#111">)</span>
<span style="color:#111">dm_split</span> <span style="color:#f92672">=</span> <span style="color:#111">rsample</span><span style="color:#f92672">::</span><span style="color:#75af00">initial_split</span><span style="color:#111">(</span><span style="color:#111">processed_dm_df</span><span style="color:#111">,</span>  <span style="color:#111">p</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.8</span><span style="color:#111">)</span>

<span style="color:#111">train_df</span> <span style="color:#f92672">=</span> <span style="color:#111">rsample</span><span style="color:#f92672">::</span><span style="color:#75af00">training</span><span style="color:#111">(</span><span style="color:#111">dm_split</span><span style="color:#111">)</span>
<span style="color:#111">test_df</span>  <span style="color:#f92672">=</span> <span style="color:#111">rsample</span><span style="color:#f92672">::</span><span style="color:#75af00">testing</span><span style="color:#111">(</span><span style="color:#111">dm_split</span><span style="color:#111">)</span>
</code></pre></div><h1 id="モデリング--parsnip-パッケージ">モデリング : parsnip パッケージ</h1>
<p>まずは目的に合わせてアルゴリズムを指定して、モデルオブジェクトを作成する。</p>
<p><code>parsnip</code> は異なるパッケージのアルゴリズムを同じインターフェースで扱えるようにする。</p>
<h2 id="モデルオブジェクトの作成">モデルオブジェクトの作成</h2>
<h3 id="線形回帰">線形回帰</h3>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#111">linear_regression_model</span> <span style="color:#f92672">&lt;-</span>
    <span style="color:#111">parsnip</span><span style="color:#f92672">::</span><span style="color:#75af00">linear_reg</span><span style="color:#111">()</span> <span style="color:#f92672">%&gt;%</span> 
    <span style="color:#111">parsnip</span><span style="color:#f92672">::</span><span style="color:#75af00">set_engine</span><span style="color:#111">(</span><span style="color:#d88200">&#34;lm&#34;</span><span style="color:#111">)</span>
</code></pre></div><h3 id="決定木">決定木</h3>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># 分類木</span>
<span style="color:#111">decision_tree_model</span> <span style="color:#f92672">&lt;-</span>
    <span style="color:#111">parsnip</span><span style="color:#f92672">::</span><span style="color:#75af00">decision_tree</span><span style="color:#111">(</span>
        <span style="color:#111">mode</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;classification&#34;</span><span style="color:#111">,</span>
        <span style="color:#111">cost_complexity</span> <span style="color:#f92672">=</span> <span style="color:#111">cost_complexity</span><span style="color:#111">,</span>
        <span style="color:#111">tree_depth</span> <span style="color:#f92672">=</span> <span style="color:#111">tree_depth</span><span style="color:#111">,</span>
        <span style="color:#111">min_n</span> <span style="color:#f92672">=</span> <span style="color:#111">min_n</span><span style="color:#111">)</span>

</code></pre></div><h2 id="ランダムフォレスト">ランダムフォレスト</h2>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#111">parsnip</span><span style="color:#f92672">::</span><span style="color:#75af00">rand_forest</span><span style="color:#111">(</span><span style="color:#111">mode</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;unknown&#34;</span><span style="color:#111">,</span> <span style="color:#111">mtry</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">,</span> <span style="color:#111">trees</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">,</span> <span style="color:#111">min_n</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">)</span>

<span style="color:#75715e">## S3 method for class &#39;rand_forest&#39;</span>
<span style="color:#75af00">update</span><span style="color:#111">(</span>
  <span style="color:#111">object</span><span style="color:#111">,</span>
  <span style="color:#111">parameters</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">,</span>
  <span style="color:#111">mtry</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">,</span>
  <span style="color:#111">trees</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">,</span>
  <span style="color:#111">min_n</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">,</span>
  <span style="color:#111">fresh</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">FALSE</span><span style="color:#111">,</span>
  <span style="color:#00a8c8">...</span>
<span style="color:#111">)</span>
</code></pre></div><ul>
<li>mode : Possible values for this model are &ldquo;unknown&rdquo;, &ldquo;regression&rdquo;, or &ldquo;classification&rdquo;.</li>
<li>mtry: The number of predictors that will be randomly sampled at each split when creating the tree models.</li>
<li>trees: The number of trees contained in the ensemble.</li>
<li>min_n: The minimum number of data points in a node that are required for the node to be split further.</li>
</ul>
<p>エンジン</p>
<p>set_engine()</p>
<ul>
<li>R: &ldquo;ranger&rdquo; (the default) or &ldquo;randomForest&rdquo;</li>
<li>Spark: &ldquo;spark&rdquo;</li>
</ul>
<h2 id="学習">学習</h2>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#111">lm_fit</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75715e"># 学習済みモデルオブジェクト</span>
  <span style="color:#111">lm_mod</span> <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#75af00">fit</span><span style="color:#111">(</span><span style="color:#111">width</span> <span style="color:#f92672">~</span> <span style="color:#111">initial_volume</span> <span style="color:#f92672">*</span> <span style="color:#111">food_regime</span><span style="color:#111">,</span> <span style="color:#75715e"># 目的変数と説明変数をフォーミュラで指定</span>
  <span style="color:#111">data</span> <span style="color:#f92672">=</span> <span style="color:#111">data_mart_df</span>
  <span style="color:#111">)</span>
</code></pre></div><h3 id="学習済みモデルオブジェクトの内容を確認する">学習済みモデルオブジェクトの内容を確認する</h3>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75af00">tidy</span><span style="color:#111">(</span><span style="color:#111">lm_fit</span><span style="color:#111">)</span>

</code></pre></div><div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># 線形回帰の学習済みオブジェクトを tidy() で処理した出力を dotwhisker::dwplot() に入力して結果を見る</span>
<span style="color:#75af00">tidy</span><span style="color:#111">(</span><span style="color:#111">lm_fit</span><span style="color:#111">)</span> <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#111">dotwhisker</span><span style="color:#f92672">::</span><span style="color:#75af00">dwplot</span><span style="color:#111">(</span><span style="color:#111">dot_args</span> <span style="color:#f92672">=</span> <span style="color:#75af00">list</span><span style="color:#111">(</span><span style="color:#111">size</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#111">,</span> <span style="color:#111">color</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;black&#34;</span><span style="color:#111">),</span>
         <span style="color:#111">whisker_args</span> <span style="color:#f92672">=</span> <span style="color:#75af00">list</span><span style="color:#111">(</span><span style="color:#111">color</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;black&#34;</span><span style="color:#111">),</span>
         <span style="color:#111">vline</span> <span style="color:#f92672">=</span> <span style="color:#75af00">geom_vline</span><span style="color:#111">(</span><span style="color:#111">xintercept</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">colour</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;grey50&#34;</span><span style="color:#111">,</span> <span style="color:#111">linetype</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#111">))</span>

</code></pre></div><h2 id="予測--predict">予測 : predict</h2>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#111">mean_pred</span> <span style="color:#f92672">&lt;-</span> 
    <span style="color:#75af00">predict</span><span style="color:#111">(</span>
        <span style="color:#111">object</span> <span style="color:#f92672">=</span> <span style="color:#111">lm_fit</span><span style="color:#111">,</span>
        <span style="color:#111">new_data</span> <span style="color:#f92672">=</span> <span style="color:#111">new_points</span><span style="color:#111">,</span>
        <span style="color:#111">type</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;conf_int&#34;</span>
        <span style="color:#111">)</span>
</code></pre></div><ul>
<li>
<p><code>object</code> : 学習済みモデルオブジェクト <code>model_fit</code> クラス</p>
</li>
<li>
<p><code>new_data</code> : 予測を適用するデータ</p>
</li>
<li>
<p><code>type</code>: 予測で出力する値のタイプ <code>&quot;numeric&quot;, &quot;class&quot;, &quot;prob&quot;, &quot;conf_int&quot;, &quot;pred_int&quot;, &quot;quantile&quot;, or &quot;raw&quot;</code>、指定しない場合はモデルの <code>mode</code> に合わせて適切に選ばれる</p>
</li>
<li>
<p><code>opts</code> : <code>type = &quot;raw &quot;</code> のときに使用される引数の値を指定したリスト</p>
</li>
<li>
<p><code>...</code> : その他の引数</p>
<ul>
<li><code>level</code> : <code>type</code> が <code>&quot;conf_int&quot;</code> または <code>&quot;pred_int&quot;</code> の時、ここで <code>level=0.95</code> のように区間の値を指定する。</li>
<li><code>std_error</code> : <code>type</code> が　<code>&quot;conf_int&quot;</code> and <code>&quot;pred_int&quot;</code> のときに、誤差の値も出力するか指定する。 <code>TRUE</code> なら出力する。 <code>FALSE</code> なら出力しない。デフォルトは <code>FALSE</code></li>
</ul>
<p>add the standard error of fit or prediction (on the scale of the linear predictors) for types of &ldquo;conf_int&rdquo; and &ldquo;pred_int&rdquo;. Default value is FALSE.</p>
<ul>
<li><code>quantile</code> : the quantile(s) for quantile regression (not implemented yet)</li>
<li><code>time</code> : the time(s) for hazard probability estimates (not implemented yet)</li>
</ul>
</li>
</ul>
<h2 id="交差検証">交差検証</h2>
<h3 id="データの分割">データの分割</h3>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75af00">vfold_cv</span><span style="color:#111">(</span><span style="color:#111">data</span><span style="color:#111">,</span> <span style="color:#111">v</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span><span style="color:#111">,</span> <span style="color:#111">repeats</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#111">strata</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">,</span> <span style="color:#111">breaks</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span><span style="color:#111">,</span> <span style="color:#00a8c8">...</span><span style="color:#111">)</span>
</code></pre></div><ul>
<li><code>data</code> : データフレーム</li>
<li><code>v</code> : CVの分割数 (fold数)</li>
<li><code>repeats</code> : CVの分割を何回繰り返すか。総計算回数は <code>v*repeats</code> になる。</li>
<li><code>strata</code> : 層別サンプリング。CV分割の時に、fold間で割合を一緒にしたい変数を指定する（例えば目的変数がカテゴリ変数の時に指定する）</li>
<li><code>breaks</code> : 整数スカラー。層別サンプリングしたい変数が連続変数の時に、連続地をいくつのビンに分けるか指定する。</li>
</ul>
<p>courgetee</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Partitioning data for CV</span>
<span style="color:#111">df_cv</span> <span style="color:#f92672">&lt;-</span> <span style="color:#111">rsample</span><span style="color:#f92672">::</span><span style="color:#75af00">vfold_cv</span><span style="color:#111">(</span><span style="color:#111">sampled_train_df</span><span style="color:#111">,</span> <span style="color:#111">v</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</code></pre></div><h3 id="チューニングしたいハイパーパラメータを指定する">チューニングしたいハイパーパラメータを指定する</h3>
<p><code>parsnip</code> パッケージでモデルオブジェクトを作成する際に、交差検証で探索したいハイパーパラメータを選ぶ。そのために、探索したいパラメータの値として <code>tune::tune()</code> を指定する。</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># モデルオブジェクトの作成と</span>
<span style="color:#75715e"># チューニングするハイパーパラメータの指定</span>
<span style="color:#111">rnd_forest_model</span> <span style="color:#f92672">&lt;-</span>
  <span style="color:#111">parsnip</span><span style="color:#f92672">::</span><span style="color:#75af00">rand_forest</span><span style="color:#111">(</span>
    <span style="color:#111">mode</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;classification&#34;</span><span style="color:#111">,</span>
    <span style="color:#111">trees</span> <span style="color:#f92672">=</span> <span style="color:#111">tune</span><span style="color:#f92672">::</span><span style="color:#75af00">tune</span><span style="color:#111">(),</span>
    <span style="color:#111">min_n</span> <span style="color:#f92672">=</span> <span style="color:#111">tune</span><span style="color:#f92672">::</span><span style="color:#75af00">tune</span><span style="color:#111">(),</span>
    <span style="color:#111">mtry</span> <span style="color:#f92672">=</span> <span style="color:#111">tune</span><span style="color:#f92672">::</span><span style="color:#75af00">tune</span><span style="color:#111">()</span>
  <span style="color:#111">)</span> <span style="color:#f92672">%&gt;%</span>
  <span style="color:#111">parsnip</span><span style="color:#f92672">::</span><span style="color:#75af00">set_engine</span><span style="color:#111">(</span><span style="color:#d88200">&#34;ranger&#34;</span><span style="color:#111">,</span> <span style="color:#111">num.threads</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span><span style="color:#111">,</span> <span style="color:#111">seed</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">42</span><span style="color:#111">)</span>


<span style="color:#75715e"># 探索するパラメータの範囲を指定した後で、</span>
<span style="color:#75715e"># その範囲の中からランダムに100個の点を抽出する</span>
<span style="color:#111">params_grid_df</span> <span style="color:#f92672">&lt;-</span>
  <span style="color:#75af00">list</span><span style="color:#111">(</span>
    <span style="color:#111">min_n</span> <span style="color:#f92672">=</span> <span style="color:#111">dials</span><span style="color:#f92672">::</span><span style="color:#75af00">min_n</span><span style="color:#111">(</span><span style="color:#111">range</span> <span style="color:#f92672">=</span> <span style="color:#75af00">c</span><span style="color:#111">(</span><span style="color:#ae81ff">100</span><span style="color:#111">,</span> <span style="color:#ae81ff">1000</span><span style="color:#111">)),</span>
    <span style="color:#111">mtry</span>  <span style="color:#f92672">=</span> <span style="color:#111">dials</span><span style="color:#f92672">::</span><span style="color:#75af00">mtry</span><span style="color:#111">(</span><span style="color:#111">range</span> <span style="color:#f92672">=</span> <span style="color:#75af00">c</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">,</span> <span style="color:#ae81ff">5</span><span style="color:#111">)),</span>
    <span style="color:#111">trees</span> <span style="color:#f92672">=</span> <span style="color:#111">dials</span><span style="color:#f92672">::</span><span style="color:#75af00">trees</span><span style="color:#111">(</span><span style="color:#111">range</span> <span style="color:#f92672">=</span> <span style="color:#75af00">c</span><span style="color:#111">(</span><span style="color:#ae81ff">100</span><span style="color:#111">,</span> <span style="color:#ae81ff">1000</span><span style="color:#111">))</span>
  <span style="color:#111">)</span> <span style="color:#f92672">%&gt;%</span>
  <span style="color:#111">tune</span><span style="color:#f92672">::</span><span style="color:#75af00">parameters</span><span style="color:#111">()</span> <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#111">dials</span><span style="color:#f92672">::</span><span style="color:#75af00">grid_random</span><span style="color:#111">(</span><span style="color:#111">size</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span><span style="color:#111">)</span> 
</code></pre></div><h3 id="cv計算の実行">CV計算の実行</h3>
<h4 id="tunetune_grid"><code>tune::tune_grid()</code></h4>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#111">cv_result_df</span> <span style="color:#f92672">&lt;-</span>
  <span style="color:#111">tune</span><span style="color:#f92672">::</span><span style="color:#75af00">tune_grid</span><span style="color:#111">(</span>
    <span style="color:#111">object</span> <span style="color:#f92672">=</span> <span style="color:#111">rnd_forest_model</span><span style="color:#111">,</span>
    <span style="color:#111">preprocessor</span> <span style="color:#f92672">=</span> <span style="color:#111">flag_detected_by_viirs</span> <span style="color:#f92672">~</span> <span style="color:#111">.,</span>
    <span style="color:#111">resamples</span> <span style="color:#f92672">=</span> <span style="color:#111">df_cv</span><span style="color:#111">,</span>
    <span style="color:#111">grid</span> <span style="color:#f92672">=</span> <span style="color:#111">params_grid_df</span><span style="color:#111">,</span>
    <span style="color:#111">metrics</span> <span style="color:#f92672">=</span> <span style="color:#111">yardstick</span><span style="color:#f92672">::</span><span style="color:#75af00">metric_set</span><span style="color:#111">(</span><span style="color:#111">yardstick</span><span style="color:#f92672">::</span><span style="color:#111">pr_auc</span><span style="color:#111">,</span> <span style="color:#111">yardstick</span><span style="color:#f92672">::</span><span style="color:#111">roc_auc</span><span style="color:#111">),</span>
    <span style="color:#111">control</span> <span style="color:#f92672">=</span> <span style="color:#111">tune</span><span style="color:#f92672">::</span><span style="color:#75af00">control_grid</span><span style="color:#111">(</span><span style="color:#111">verbose</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">TRUE</span><span style="color:#111">)</span>
  <span style="color:#111">)</span>
</code></pre></div><ul>
<li><code>object</code> : <code>parsnip</code> パッケージで作成したモデルオブジェクト、あるいは 内部でモデルを保持した <code>workflows::workflow()</code> で作成したワークフローオブジェクト</li>
<li><code>preprocessor</code> : モデルフォーミュラ、あるいは、<code>recipes::recipe()</code> で作成したレシピオブジェクト</li>
<li><code>resamples</code> : <code>rset</code> オブジェクト、<code>rsample::vfold_cv()</code> の出力結果</li>
<li><code>param_info</code> : 探索したいハイパーパラメータの値の範囲、<code>dials::parameters()</code> オブジェクト、あるいは <code>NULL</code></li>
<li><code>grid</code> : 1. <code>param_info=NULL</code>の時、探索したい具体的なパラメータの値が記録されたデータフレーム（カラム名はハイパーパラメータ名と一致する）、 2. 正の整数値、 <code>param_info</code> に値が渡されたとき （<code>param_info</code> の範囲から <code>grid</code> で指定された数のハイパーパラメータ点が探索される）</li>
<li><code>metrics</code> : 計算したい精度指標を  <code>yardstick::metric_set()</code> を使って指定する。 <code>NULL</code> なら自動で選ばれる</li>
<li><code>control</code> : チューニングをいじるために使われるオブジェクト。<code>control = tune::control_grid(verbose = TRUE)</code> でCVの経過を出力する</li>
</ul>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e">## S3 method for class &#39;model_spec&#39;</span>
<span style="color:#75af00">tune_grid</span><span style="color:#111">(</span>
  <span style="color:#111">object</span><span style="color:#111">,</span>
  <span style="color:#111">preprocessor</span><span style="color:#111">,</span>
  <span style="color:#111">resamples</span><span style="color:#111">,</span>
  <span style="color:#00a8c8">...</span><span style="color:#111">,</span>
  <span style="color:#111">param_info</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">,</span>
  <span style="color:#111">grid</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span><span style="color:#111">,</span>
  <span style="color:#111">metrics</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">,</span>
  <span style="color:#111">control</span> <span style="color:#f92672">=</span> <span style="color:#75af00">control_grid</span><span style="color:#111">()</span>
<span style="color:#111">)</span>

<span style="color:#75715e">## S3 method for class &#39;workflow&#39;</span>
<span style="color:#75af00">tune_grid</span><span style="color:#111">(</span>
  <span style="color:#111">object</span><span style="color:#111">,</span>
  <span style="color:#111">resamples</span><span style="color:#111">,</span>
  <span style="color:#00a8c8">...</span><span style="color:#111">,</span>
  <span style="color:#111">param_info</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">,</span>
  <span style="color:#111">grid</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span><span style="color:#111">,</span>
  <span style="color:#111">metrics</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">,</span>
  <span style="color:#111">control</span> <span style="color:#f92672">=</span> <span style="color:#75af00">control_grid</span><span style="color:#111">()</span>
<span style="color:#111">)</span>
</code></pre></div><h4 id="tunefit_resamples"><code>tune::fit_resamples()</code></h4>
<p>CVのなかの1つの計算は <code>tune::fit_resamples()</code> が使われている？？</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e">## S3 method for class &#39;model_spec&#39;</span>
<span style="color:#75af00">fit_resamples</span><span style="color:#111">(</span>
  <span style="color:#111">object</span><span style="color:#111">,</span>
  <span style="color:#111">preprocessor</span><span style="color:#111">,</span>
  <span style="color:#111">resamples</span><span style="color:#111">,</span>
  <span style="color:#00a8c8">...</span><span style="color:#111">,</span>
  <span style="color:#111">metrics</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">,</span>
  <span style="color:#111">control</span> <span style="color:#f92672">=</span> <span style="color:#75af00">control_resamples</span><span style="color:#111">()</span>
<span style="color:#111">)</span>

<span style="color:#75715e">## S3 method for class &#39;workflow&#39;</span>
<span style="color:#75af00">fit_resamples</span><span style="color:#111">(</span>
  <span style="color:#111">object</span><span style="color:#111">,</span>
  <span style="color:#111">resamples</span><span style="color:#111">,</span>
  <span style="color:#00a8c8">...</span><span style="color:#111">,</span>
  <span style="color:#111">metrics</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">,</span>
  <span style="color:#111">control</span> <span style="color:#f92672">=</span> <span style="color:#75af00">control_resamples</span><span style="color:#111">()</span>
<span style="color:#111">)</span>
</code></pre></div><h3 id="cv結果の確認">CV結果の確認</h3>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#111">tune</span><span style="color:#f92672">::</span><span style="color:#75af00">collect_metrics</span><span style="color:#111">(</span><span style="color:#111">cv_result_df</span><span style="color:#111">)</span> <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#75af00">filter</span><span style="color:#111">(</span><span style="color:#111">.metric</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;pr_auc&#34;</span><span style="color:#111">)</span> <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#75af00">arrange</span><span style="color:#111">(</span><span style="color:#75af00">desc</span><span style="color:#111">(</span><span style="color:#111">mean</span><span style="color:#111">))</span>

</code></pre></div><p>ベストのパラメターで再学習</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#111">best_param</span>  <span style="color:#f92672">&lt;-</span>
  <span style="color:#111">cv_result_df</span> <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75af00">select_best</span><span style="color:#111">(</span><span style="color:#111">metric</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;pr_auc&#34;</span><span style="color:#111">)</span> <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75af00">select</span><span style="color:#111">(</span><span style="color:#ae81ff">-.</span><span style="color:#111">config</span><span style="color:#111">)</span>

<span style="color:#111">model_best</span>  <span style="color:#f92672">&lt;-</span>  <span style="color:#75af00">update</span><span style="color:#111">(</span><span style="color:#111">rnd_forest_model</span><span style="color:#111">,</span> <span style="color:#111">best_param</span><span style="color:#111">)</span>


<span style="color:#111">fitted_model</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">fit</span><span style="color:#111">(</span><span style="color:#111">model_best</span><span style="color:#111">,</span>
                    <span style="color:#111">formula</span> <span style="color:#f92672">=</span> <span style="color:#111">flag_detected_by_viirs</span> <span style="color:#f92672">~</span> <span style="color:#111">.,</span>
                    <span style="color:#111">data</span> <span style="color:#f92672">=</span> <span style="color:#111">sampled_train_df</span><span style="color:#111">)</span>

</code></pre></div><h3 id="モデルオブジェクトの作成と探索するハイパラの指定">モデルオブジェクトの作成と探索するハイパラの指定</h3>
<h1 id="精度検証">精度検証</h1>
<ul>
<li><code>yardstick::roc_auc()</code></li>
<li><code>yardstick::pr_auc()</code></li>
<li><code>yardstick::gain_curve()</code></li>
<li><code>yardstick::lift_curve()</code></li>
<li><code>yardstick::roc_curve()</code></li>
</ul>
<h1 id="前処理--recipes-パッケージ">前処理 : recipes パッケージ</h1>
<h2 id="レシピオブジェクトの作成--recipe">レシピオブジェクトの作成 : recipe()</h2>
<p>最初に、変数加工のためのパラメタ（標準化のための平均と分散など）を決めるために使う訓練データ（一般には訓練データ）</p>
<p>そのデータに含まれる目的変数と説明変数をフォーミュラとして与える。</p>
<p>モデル式（目的変数と説明変数）を指定</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#111">recipes</span><span style="color:#f92672">::</span><span style="color:#75af00">recipe</span><span style="color:#111">(</span><span style="color:#111">x</span><span style="color:#111">,</span> <span style="color:#111">formula</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">,</span> <span style="color:#00a8c8">...</span><span style="color:#111">,</span> <span style="color:#111">vars</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">,</span> <span style="color:#111">roles</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">)</span>
</code></pre></div><ul>
<li><code>x</code>, <code>data</code> : 変数加工のためのパラメタ（標準化のための平均と分散など）を決めるために使う訓練データ</li>
<li><code>formula</code> : モデル式、目的変数と説明変数の指定。<code>log(x)</code> とか <code>x:y</code> などの関数を含めてはいけない。マイナス符号をつけるのもダメ。</li>
<li><code>vars</code> : 変数名を格納した文字列ベクトル</li>
<li><code>roles</code> : <code>vars</code> と同じ長さの文字列ベクトル。各変数の役割を指定する。<code>&quot;outcome&quot;, &quot;predictor&quot;, &quot;case_weight&quot;, or &quot;ID&quot;</code> 他の値でもいい</li>
</ul>
<pre><code>mod_rec &lt;- 
  df_rental %&gt;% 
  recipe(formula = Y ~ Area)
</code></pre><h2 id="step_">step_*()</h2>
<p>データに対する加工は <code>step_*()</code> 関数を使う</p>
<h3 id="skiptrue-について"><code>skip=TRUE</code> について</h3>
<p><code>skip=TRUE</code> が指定されたステップは、 <code>prep()</code> を実行したときには適用されるが、<code>bake()</code> を実行したときには適用されない。</p>
<p>次のように考えてもよいかもしれない</p>
<ul>
<li><code>prep()</code> は訓練データ作成用にレシピを実行する。</li>
<li><code>bake()</code> は新データ・テストデータ・検証データ作成用にレシピを実行する</li>
</ul>
<p><code>skip = TRUE</code> を指定された処理は訓練データを作成するときには使用されるが、新データやテストデータや検証データに対しては使用されない。一般的にはモデリングのために目的変数を使ったサンプリングを実施するステップに対しては <code>skip = TRUE</code> を指定する。</p>
<h3 id="対数変換--step_log">対数変換 : step_log()</h3>
<p>step_log(Y, Area)</p>
<h3 id="交互作用変数の追加--step_interact">交互作用変数の追加 : step_interact()</h3>
<p>step_interact(terms = ~ Solar.R:Wind)</p>
<h3 id="step_-の中での変数の指定の仕方">step_*() の中での変数の指定の仕方</h3>
<p>step_log(all_predictors(), all_outcomes())</p>
<p>dplyrの　starts_with() contains() 等も使える</p>
<h2 id="prep-パラメータを持つステップの訓練更新">prep() パラメータを持つステップの訓練・更新</h2>
<pre><code>rec_trained &lt;- 
  prep(mod_rec, retain = TRUE, verbose = TRUE)
</code></pre><ul>
<li><code>retain</code> : 処理済みの訓練データをオブジェクト内に保持する (<code>template</code> スロット)。後からステップを追加したいが、既存のステップの再トレーニングを避けたい場合に良いアイデア。<code>skip = FALSE</code> オプションを使用しているステップがある場合は、<code>retain = TRUE</code> を使用することをお勧めします。</li>
<li><code>training</code> : データ処理のパラメタ（標準化のための平均と分散とか）の訓練のために使うデータフレームを別に指定する場合</li>
<li><code>fresh</code> : <code>TRUE</code> なら、新たに訓練データを与えてパラメータを更新する。同時に、<code>training</code> に新たな訓練データを与えること。<code>fresh=TRUE</code> は前に <code>prep()</code> した <code>step_*()</code> の方も更新する。<code>fresh=FALSE</code> なら まだ <code>prep()</code> されていない <code>step_*()</code> を更新する。</li>
</ul>
<h2 id="レシピを新しいデータに適用する-bake">レシピを新しいデータに適用する bake()</h2>
<p>以前は <code>bake()</code> は新データにレシピを適用する。 <code>juice()</code> はレシピ内に保持されたデータに対してレシピを適用するという意味だったが。今は <code>juice()</code> の代わりに <code>bake(newdata=NULL)</code> を使うことが推奨されている。</p>
</article>

      
<div class="book-footer justify-end">
  
  
  <div>
    
    <a class="flex align-center" href="https://github.com/teuder/notebook/edit/master/content/R/tidymodels.md" target="_blank" rel="noopener">
      <img src="/notebook/svg/edit.svg" alt="Edit" />
      <span>Edit this page</span>
    </a>
    
  </div>
  
</div>


      
    </div>

    
  

  <aside class="book-toc level-3 fixed">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#traintest-分割">Train/Test 分割</a></li>
  </ul>

  <ul>
    <li><a href="#モデルオブジェクトの作成">モデルオブジェクトの作成</a>
      <ul>
        <li><a href="#線形回帰">線形回帰</a></li>
        <li><a href="#決定木">決定木</a></li>
      </ul>
    </li>
    <li><a href="#ランダムフォレスト">ランダムフォレスト</a></li>
    <li><a href="#学習">学習</a>
      <ul>
        <li><a href="#学習済みモデルオブジェクトの内容を確認する">学習済みモデルオブジェクトの内容を確認する</a></li>
      </ul>
    </li>
    <li><a href="#予測--predict">予測 : predict</a></li>
    <li><a href="#交差検証">交差検証</a>
      <ul>
        <li><a href="#データの分割">データの分割</a></li>
        <li><a href="#チューニングしたいハイパーパラメータを指定する">チューニングしたいハイパーパラメータを指定する</a></li>
        <li><a href="#cv計算の実行">CV計算の実行</a></li>
        <li><a href="#cv結果の確認">CV結果の確認</a></li>
        <li><a href="#モデルオブジェクトの作成と探索するハイパラの指定">モデルオブジェクトの作成と探索するハイパラの指定</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#レシピオブジェクトの作成--recipe">レシピオブジェクトの作成 : recipe()</a></li>
    <li><a href="#step_">step_*()</a>
      <ul>
        <li><a href="#skiptrue-について"><code>skip=TRUE</code> について</a></li>
        <li><a href="#対数変換--step_log">対数変換 : step_log()</a></li>
        <li><a href="#交互作用変数の追加--step_interact">交互作用変数の追加 : step_interact()</a></li>
        <li><a href="#step_-の中での変数の指定の仕方">step_*() の中での変数の指定の仕方</a></li>
      </ul>
    </li>
    <li><a href="#prep-パラメータを持つステップの訓練更新">prep() パラメータを持つステップの訓練・更新</a></li>
    <li><a href="#レシピを新しいデータに適用する-bake">レシピを新しいデータに適用する bake()</a></li>
  </ul>
</nav>
  </aside>



  </main>

  
</body>

</html>
